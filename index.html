<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduCalendar Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    
    <!-- Firebase SDK v9 (modular) -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // TODO: Replace these values with your Firebase project credentials
        // You can find these in your Firebase Console:
        // 1. Go to https://console.firebase.google.com/
        // 2. Select your project (or create a new one)
        // 3. Click on the gear icon (Project Settings)
        // 4. Scroll down to "Your apps" section
        // 5. If you haven't added a web app, click "Add app" and select Web (</>)
        // 6. Copy the configuration values and paste them below
        
        const firebaseConfig = {
            apiKey: "AIzaSyD6Z2qvFCp5CamwBkgrpxOl8vloFE8aks4",
            authDomain: "dmytro-eng-calendar.firebaseapp.com",
            projectId: "dmytro-eng-calendar",
            storageBucket: "dmytro-eng-calendar.firebasestorage.app",
            messagingSenderId: "163421877077",
            appId: "1:163421877077:web:1b8d55ba6ea1cd1f6675dc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.firestoreModules = {
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            setDoc
        };
        
        console.log('Firebase initialized successfully!');
    </script>
    
    <style>
        :root {
            --primary: #05cf05;
            --secondary: #dff65c;
        }
        .calendar-day:hover {
            transform: scale(1.05);
        }
        .student-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        #vanta-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }
        .unpaid-event {
    background-color: #fee2e2 !important;
    color: #991b1b !important;
    border: 1px solid #fca5a5;
}
.dark .unpaid-event {
    background-color: #7f1d1d !important;
    color: #fca5a5 !important;
    border: 1px solid #991b1b;
}
/* Event card hover states for dark mode */
.dark .calendar-day .bg-indigo-100:hover {
    background-color: #4338ca !important;
}

.dark .calendar-day .bg-red-100:hover {
    background-color: #991b1d !important;
}

/* Day view event cards in dark mode */
.dark #day-view-content .border {
    background-color: #374151;
}

.dark #day-view-content .border:hover {
    background-color: #4b5563 !important;
}

.dark #day-view-content .border-red-300 {
    background-color: #7f1d1d !important;
    border-color: #991b1b !important;
}

.dark #day-view-content .border-red-300:hover {
    background-color: #991b1d !important;
}

.dark #day-view-content .bg-red-50 {
    background-color: #7f1d1d !important;
}

/* Current day highlight */
.current-day {
    background-color: #dbeafe !important;
    border: 2px solid #3b82f6 !important;
}

.dark .current-day {
    background-color: #1e3a8a !important;
    border: 2px solid #60a5fa !important;
}
        /* Login page styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        .dark .login-box {
            background: #1f2937;
        }
        .hidden {
            display: none !important;
        }
        .tab-button.active {
            background-color: #73e546;
            color: white;
        }
        
        /* Dark mode styles */
        .dark .bg-green-50 {
    background-color: #064e3b !important;
}
.dark .text-green-800 {
    color: #6ee7b7 !important;
}
.dark .text-green-600 {
    color: #34d399 !important;
}
.dark .bg-blue-50 {
    background-color: #1e3a8a !important;
}
.dark .text-blue-800 {
    color: #93c5fd !important;
}
.dark .text-blue-600 {
    color: #60a5fa !important;
}
.dark .text-red-600 {
    color: #f87171 !important;
}
.dark .bg-red-50 {
    background-color: #7f1d1d !important;
}
.dark .text-red-800 {
    color: #fca5a5 !important;
}
.dark .bg-indigo-50 {
    background-color: #312e81 !important;
}
.dark .text-indigo-600 {
    color: #3c5cff !important;
}
.dark .text-indigo-800 {
    color: #98acff !important;
}
        .dark {
            background-color: #111827;
            color: #fbf9fa;
        }
        .dark .bg-white {
            background-color: #1f2937 !important;
            color: #fbf9fb;
        }
        .dark .bg-gray-50 {
            background-color: #111827 !important;
        }
        .dark .text-gray-800 {
            color: #fbf9fb !important;
        }
        .dark .text-gray-700 {
            color: #d1d5db !important;
        }
        .dark .text-gray-600 {
            color: #9ca3af !important;
        }
        .dark .text-gray-500 {
            color: #6b7280 !important;
        }
        .dark .border {
            border-color: #374151 !important;
        }
        .dark input, .dark select, .dark textarea {
            background-color: #374151 !important;
            color: #f9fafb !important;
            border-color: #4b5563 !important;
        }
        .dark .bg-gray-100 {
            background-color: #374151 !important;
        }
        .dark .bg-gray-200 {
            background-color: #4b5563 !important;
        }
        .dark #vanta-bg {
            opacity: 0.05;
        }
        .dark ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.dark ::-webkit-scrollbar-track {
    background: #1f2937;
}

.dark ::-webkit-scrollbar-thumb {
    background: #4b5563;
    border-radius: 4px;
}

.dark ::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
}
.dark .bg-indigo-100 {
    background-color: #312e81 !important;
}
.dark .text-indigo-800 {
    color: #a5b4fc !important;
}
.dark #day-view-modal .bg-white,
.dark #event-modal .bg-white,
.dark #notes-modal .bg-white,
.dark #copy-modal .bg-white,
.dark #announcement-modal .bg-white {
    background-color: #1f2937 !important;
    color: #f9fafb !important;
}
.dark .rounded-xl {
    background-color: #1f2937;
}

.dark .border {
    border-color: #374151 !important;
}
.dark .bg-white {
    background-color: #1f2937 !important;
    color: #f9fafb;
}
.dark div.bg-white.rounded-xl {
    background-color: #1f2937 !important;
}

.dark div.bg-white {
    background-color: #1f2937 !important;
}

/* Firefox scrollbar for dark mode */
.dark * {
    scrollbar-width: thin;
    scrollbar-color: #4b5563 #1f2937;
}

/* Student balance card styles */
.balance-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 1rem;
    padding: 1.5rem;
    color: white;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
}

.dark .balance-card {
    background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
}

/* Announcement styles */
.announcement-banner {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-left: 4px solid #34d399;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dark .announcement-banner {
    background: linear-gradient(135deg, #065f46 0%, #047857 100%);
    border-left-color: #10b981;
}
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <div class="text-center mb-6">
                <i data-feather="calendar" class="text-indigo-600 w-16 h-16 mx-auto mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">EduCalendar Pro</h1>
                <p class="text-gray-600 mt-2">Enter your access code</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Access Code</label>
                    <input type="password" id="login-code" 
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter your code">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="keep-logged-in" class="mr-2">
                    <label for="keep-logged-in" class="text-sm text-gray-700">Keep me logged in</label>
                </div>
                <button id="login-btn" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">
                    Sign In
                </button>
                <div id="login-error" class="text-red-600 text-sm text-center hidden mt-2"></div>
            </div>
        </div>
    </div>

    <!-- Main App Content (initially hidden) -->
    <div id="app-content" class="hidden">
    <div id="vanta-bg"></div>
    
    <!-- Loading indicator -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6">
            <div class="spinner"></div>
            <p class="text-center mt-4 text-gray-700">Loading data...</p>
        </div>
    </div>
    
    <!-- Header (40% thinner) -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-2.5 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-feather="calendar" class="text-indigo-600 w-5 h-5"></i>
                <h1 class="text-xl font-bold text-gray-800">EduCalendar Pro</h1>
                <span id="sync-status" class="text-xs text-green-600 ml-2">● Synced</span>
                <span id="user-role-badge" class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded ml-2"></span>
            </div>
            <div class="flex space-x-3">
                <button id="copy-week-btn" class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition flex items-center admin-only">
                    <i data-feather="copy" class="mr-1.5 w-4 h-4"></i>Copy Week/Month
                </button>
                <button id="announcement-btn" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition flex items-center admin-only">
                    <i data-feather="message-square" class="mr-1.5 w-4 h-4"></i>Announcement
                </button>
                <button id="theme-toggle" class="p-1.5 rounded-full bg-gray-100 hover:bg-gray-200">
                    <i data-feather="moon" class="text-gray-700 w-4 h-4"></i>
                </button>
                <button id="new-event-btn" class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition flex items-center admin-only">
                    <i data-feather="plus" class="mr-1.5 w-4 h-4"></i>New Event
                </button>
                <button id="logout-btn" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition flex items-center">
                    <i data-feather="log-out" class="mr-1.5 w-4 h-4"></i>Logout
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Announcement Banner (visible to all when active) -->
        <div id="announcement-banner" class="hidden announcement-banner rounded-xl p-4 mb-6 text-white shadow-lg">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h3 id="announcement-banner-title" class="font-bold text-lg mb-2"></h3>
                    <p id="announcement-banner-message" class="text-sm opacity-90 whitespace-pre-wrap"></p>
                </div>
                <button id="close-announcement-banner" class="ml-4 p-1 hover:bg-white hover:bg-opacity-20 rounded">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Student Management Section -->
            <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6">
                <!-- Tabs -->
                <div class="flex mb-6 border-b">
                    <button id="students-tab" class="tab-button flex-1 py-3 font-semibold transition active">
                        <i data-feather="users" class="mr-2 inline"></i>Students
                    </button>
                    <button id="payments-tab" class="tab-button flex-1 py-3 font-semibold text-gray-600 transition">
                        <i data-feather="credit-card" class="mr-2 inline"></i>Payments
                    </button>
                </div>
                
                <!-- Students Content -->
                <div id="students-content">
                    <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                        <i data-feather="users" class="mr-2"></i> Student Management
                    </h2>
                    
                    <!-- Add Student Form -->
                    <div class="mb-6">
                        <div class="flex space-x-2 mb-4">
                            <input type="text" id="student-name" placeholder="Student Name" 
                                   class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <input type="number" id="student-rate" placeholder="Rate" 
                                   class="w-24 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="add-student" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-800 transition">
                                <i data-feather="plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Students List -->
                    <div class="space-y-3 max-h-200 overflow-y-auto pr-2" id="students-list">
                        <!-- Student cards will be added here dynamically -->
                    </div>
                </div>

                <!-- Payments Content -->
                <div id="payments-content" class="hidden">
                    <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                        <i data-feather="credit-card" class="mr-2"></i> Payment Tracking
                    </h2>
                    
                    <div class="space-y-4 max-h-200 overflow-y-auto pr-2" id="payments-list">
                        <!-- Payment cards will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <!-- Calendar Header -->
                    <div class="flex justify-between items-center mb-6">
    <div class="flex items-center space-x-3">
        <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i data-feather="calendar" class="mr-2"></i> Schedule
        </h2>
        <button id="today-btn" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition flex items-center">
            <i data-feather="calendar-check" class="mr-1.5 w-4 h-4"></i>Today
        </button>
    </div>
    <div class="flex space-x-2">
        <button id="prev-month" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
            <i data-feather="chevron-left"></i>
        </button>
        <h3 id="current-month" class="text-lg font-semibold px-4 py-1">January 2023</h3>
        <button id="next-month" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
            <i data-feather="chevron-right"></i>
        </button>
    </div>
</div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <div class="text-center font-medium text-gray-500 py-2">Sun</div>
                        <div class="text-center font-medium text-gray-500 py-2">Mon</div>
                        <div class="text-center font-medium text-gray-500 py-2">Tue</div>
                        <div class="text-center font-medium text-gray-500 py-2">Wed</div>
                        <div class="text-center font-medium text-gray-500 py-2">Thu</div>
                        <div class="text-center font-medium text-gray-500 py-2">Fri</div>
                        <div class="text-center font-medium text-gray-500 py-2">Sat</div>
                    </div>
                    
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days will be populated here by JavaScript -->
                    </div>
                </div>
                
                <!-- Financial Summary -->
                <div class="mt-6 bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                        <i data-feather="dollar-sign" class="mr-2"></i> Financial Summary
                    </h2>
                    
                    <div id="student-totals" class="space-y-3 mb-4 max-h-48 overflow-y-auto">
                        <!-- Student totals will be added here dynamically -->
                    </div>
                    
                    <div class="border-t pt-4 mt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700">Month Total:</span>
                            <span id="month-total" class="text-xl font-bold text-indigo-600">₴0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Student Notes Modal -->
    <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold" id="notes-modal-title">Notes for [Student]</h3>
                <button id="close-notes-modal" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="mb-4">
                <textarea id="student-notes-textarea" rows="10" 
                          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                          placeholder="Enter notes for this student..."></textarea>
            </div>
            <div class="flex justify-end">
                <button id="save-student-notes" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Save Notes
                </button>
            </div>
        </div>
    </div>

    <!-- Day View Modal -->
    <div id="day-view-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold" id="day-view-title">Events for [Date]</h3>
                <button id="close-day-view" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div id="day-view-content" class="space-y-3 mb-4">
                <!-- Events will be listed here -->
            </div>
            <div class="flex justify-end pt-2 border-t">
                <button id="add-event-from-day-view" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    <i data-feather="plus" class="mr-2"></i>Add Event
                </button>
            </div>
        </div>
    </div>

    <!-- Copy Week/Month Modal -->
    <div id="copy-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Copy Events</h3>
                <button id="close-copy-modal" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Copy Type</label>
                    <select id="copy-type" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="date" id="copy-from-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                    <input type="date" id="copy-to-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button id="cancel-copy" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                        Cancel
                    </button>
                    <button id="execute-copy" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        Copy Events
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Schedule Event</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="text" id="event-date" readonly 
                           class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                    <select id="event-time" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <!-- Time options will be added dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Student</label>
                    <select id="event-student" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <!-- Options will be added dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="event-notes" rows="3" 
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button id="delete-event" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition hidden">
                        Delete
                    </button>
                    <button id="save-event" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Announcement Modal (Admin Only) -->
    <div id="announcement-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Post Announcement</h3>
                <button id="close-announcement-modal" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Announcement Title</label>
                    <input type="text" id="announcement-title" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter title...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                    <textarea id="announcement-message" rows="6" 
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="Enter your announcement message..."></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="announcement-active" class="mr-2" checked>
                    <label for="announcement-active" class="text-sm text-gray-700">Show to students</label>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button id="delete-announcement" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                        Clear Announcement
                    </button>
                    <button id="save-announcement" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Save & Publish
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Vanta.js background
        VANTA.GLOBE({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: "#6366f1",
            backgroundColor: "#f9fafb"
        });

       // Initialize Feather Icons
feather.replace();

// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    ADMIN_CODE: 'aradeCTIoNicareYdRECO',
    TIME_SLOTS: { start: 8, end: 20 },
    STORAGE_KEY: 'eduCalendarAuth',
    ACCESS_CODE_LENGTH: 8,
    MAX_INIT_ATTEMPTS: 50,
    FIREBASE_CHECK_INTERVAL: 100,
    NOTIFICATION_DURATION: 3000,
    MAX_STUDENT_NAME_LENGTH: 100,
    MAX_RATE: 100000
};

// Wait for Firebase to be ready - OPTIMIZED
let firebaseReady = false;
let initAttempts = 0;

        // App state
        let state = {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDate: null,
            selectedStudent: null,
            editingEventId: null,
            students: [],
            events: [],
            paidLessons: {},
            studentNotes: {},
            isDarkMode: false,
            // NEW: Authentication state
            isAuthenticated: false,
            currentUser: null, // { role: 'admin' | 'student', code: string, studentId?: string }
            adminCode: CONFIG.ADMIN_CODE,
            announcement: {
                title: '',
                message: '',
                active: false,
                dismissed: false
            }
        };
        // DEBUG: Log the initial state
console.log('Initial state:', state.currentMonth, state.currentYear);
console.log('Should be:', new Date().getMonth(), new Date().getFullYear());

        // DOM Elements
        const elements = {
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthDisplay: document.getElementById('current-month'),
            studentsList: document.getElementById('students-list'),
            studentTotals: document.getElementById('student-totals'),
            monthTotal: document.getElementById('month-total'),
            studentNameInput: document.getElementById('student-name'),
            studentRateInput: document.getElementById('student-rate'),
            addStudentBtn: document.getElementById('add-student'),
            prevMonthBtn: document.getElementById('prev-month'),
            nextMonthBtn: document.getElementById('next-month'),
            eventModal: document.getElementById('event-modal'),
            closeModalBtn: document.getElementById('close-modal'),
            eventDateInput: document.getElementById('event-date'),
            eventTimeSelect: document.getElementById('event-time'),
            eventStudentSelect: document.getElementById('event-student'),
            eventNotesInput: document.getElementById('event-notes'),
            saveEventBtn: document.getElementById('save-event'),
            deleteEventBtn: document.getElementById('delete-event'),
            themeToggle: document.getElementById('theme-toggle'),
            newEventBtn: document.getElementById('new-event-btn'),
            dayViewModal: document.getElementById('day-view-modal'),
            closeDayViewBtn: document.getElementById('close-day-view'),
            dayViewTitle: document.getElementById('day-view-title'),
            dayViewContent: document.getElementById('day-view-content'),
            addEventFromDayViewBtn: document.getElementById('add-event-from-day-view'),
            studentsTab: document.getElementById('students-tab'),
            paymentsTab: document.getElementById('payments-tab'),
            studentsContent: document.getElementById('students-content'),
            paymentsContent: document.getElementById('payments-content'),
            paymentsList: document.getElementById('payments-list'),
            copyWeekBtn: document.getElementById('copy-week-btn'),
            copyModal: document.getElementById('copy-modal'),
            closeCopyModal: document.getElementById('close-copy-modal'),
            copyType: document.getElementById('copy-type'),
            copyFromDate: document.getElementById('copy-from-date'),
            copyToDate: document.getElementById('copy-to-date'),
            executeCopy: document.getElementById('execute-copy'),
            cancelCopy: document.getElementById('cancel-copy'),
            notesModal: document.getElementById('notes-modal'),
            closeNotesModal: document.getElementById('close-notes-modal'),
            notesModalTitle: document.getElementById('notes-modal-title'),
            studentNotesTextarea: document.getElementById('student-notes-textarea'),
            saveStudentNotes: document.getElementById('save-student-notes'),
            loadingOverlay: document.getElementById('loading-overlay'),
            syncStatus: document.getElementById('sync-status'),
            // NEW: Authentication elements
            loginPage: document.getElementById('login-page'),
            appContent: document.getElementById('app-content'),
            loginCode: document.getElementById('login-code'),
            loginBtn: document.getElementById('login-btn'),
            loginError: document.getElementById('login-error'),
            keepLoggedIn: document.getElementById('keep-logged-in'),
            logoutBtn: document.getElementById('logout-btn'),
            userRoleBadge: document.getElementById('user-role-badge'),
            // Announcement elements
            announcementBtn: document.getElementById('announcement-btn'),
            announcementModal: document.getElementById('announcement-modal'),
            closeAnnouncementModal: document.getElementById('close-announcement-modal'),
            announcementTitle: document.getElementById('announcement-title'),
            announcementMessage: document.getElementById('announcement-message'),
            announcementActive: document.getElementById('announcement-active'),
            saveAnnouncement: document.getElementById('save-announcement'),
            deleteAnnouncement: document.getElementById('delete-announcement'),
            announcementBanner: document.getElementById('announcement-banner'),
            announcementBannerTitle: document.getElementById('announcement-banner-title'),
            announcementBannerMessage: document.getElementById('announcement-banner-message'),
            closeAnnouncementBanner: document.getElementById('close-announcement-banner'),
            todayBtn: document.getElementById('today-btn')
        };

        // Setup login listeners NOW (after elements is defined)
    elements.loginBtn.addEventListener('click', handleLogin);
    elements.loginCode.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });
    elements.logoutBtn.addEventListener('click', handleLogout);

   // Continue with Firebase check
const checkFirebase = setInterval(() => {
    initAttempts++;
    
    if (window.db && window.firestoreModules) {
        clearInterval(checkFirebase);
        firebaseReady = true;
        
        // Check for existing authentication
        const hasAuth = checkExistingAuth();
        if (hasAuth) {
            elements.loginPage.classList.add('hidden');
            elements.appContent.classList.remove('hidden');
            updateUIForRole();
            init();
        } else {
            // Show login page and ensure icons are rendered
            elements.loginPage.classList.remove('hidden');
            feather.replace();
        }
    } else if (initAttempts >= CONFIG.MAX_INIT_ATTEMPTS) {
        // Firebase failed to load
        clearInterval(checkFirebase);
        console.error('Firebase initialization timeout');
        alert('Failed to connect to database. Please refresh the page.');
    }
}, CONFIG.FIREBASE_CHECK_INTERVAL);

        // ============================================
        // FIREBASE FUNCTIONS
        // ============================================
        // ============================================
        // FIREBASE SERVICE MODULE
        // ============================================
        
        const FirebaseService = {
            async withErrorHandling(operation, errorMessage) {
                try {
                    updateSyncStatus(false);
                    await operation();
                    updateSyncStatus(true);
                } catch (error) {
                    console.error(errorMessage, error);
                    showNotification(errorMessage, 'error');
                    updateSyncStatus(true);
                    throw error;
                }
            },
            
            async loadStudents() {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.db, 'students'));
                const students = [];
                snapshot.forEach((doc) => {
                    students.push({
                        id: doc.id,
                        ...doc.data(),
                        accessCode: doc.data().accessCode || null
                    });
                });
                return students;
            },
            
            async loadEvents() {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.db, 'events'));
                const events = [];
                snapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                return events;
            },
            
            async loadPaidLessons() {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.db, 'paidLessons'));
                const paidLessons = {};
                snapshot.forEach((doc) => {
                    paidLessons[doc.id] = doc.data().count || 0;
                });
                return paidLessons;
            },
            
            async loadStudentNotes() {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.db, 'studentNotes'));
                const notes = {};
                snapshot.forEach((doc) => {
                    notes[doc.id] = doc.data().notes || '';
                });
                return notes;
            },
            
            async loadSettings() {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.db, 'settings'));
                let settings = {};
                snapshot.forEach((doc) => {
                    if (doc.id === 'appSettings') {
                        settings = doc.data();
                    }
                });
                return settings;
            }
        };
        // ============================================
        // ANNOUNCEMENT FUNCTIONS
        // ============================================
        
        async function loadAnnouncementFromFirestore() {
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.db, 'announcements'));
                
                snapshot.forEach((doc) => {
                    if (doc.id === 'current') {
                        const data = doc.data();
                        state.announcement = {
                            title: data.title || '',
                            message: data.message || '',
                            active: data.active || false,
                            dismissed: false
                        };
                    }
                });
                
                displayAnnouncementBanner();
            } catch (error) {
                console.error('Error loading announcement:', error);
            }
        }
        
        async function saveAnnouncementToFirestore() {
            try {
                updateSyncStatus(false);
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.db, 'announcements', 'current'), {
                    title: state.announcement.title,
                    message: state.announcement.message,
                    active: state.announcement.active,
                    updatedAt: new Date().toISOString()
                });
                console.log('Announcement saved to Firestore');
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error saving announcement:', error);
                updateSyncStatus(true);
            }
        }
        
        function openAnnouncementModal() {
            elements.announcementTitle.value = state.announcement.title || '';
            elements.announcementMessage.value = state.announcement.message || '';
            elements.announcementActive.checked = state.announcement.active || false;
            elements.announcementModal.classList.remove('hidden');
            feather.replace();
        }
        
        async function saveAnnouncement() {
            state.announcement.title = elements.announcementTitle.value.trim();
            state.announcement.message = elements.announcementMessage.value.trim();
            state.announcement.active = elements.announcementActive.checked;
            state.announcement.dismissed = false;
            
            await saveAnnouncementToFirestore();
            elements.announcementModal.classList.add('hidden');
            displayAnnouncementBanner();
            showNotification('Announcement published successfully!', 'success');
        }
        
        async function deleteAnnouncement() {
            if (confirm('Are you sure you want to clear the announcement?')) {
                state.announcement = {
                    title: '',
                    message: '',
                    active: false,
                    dismissed: false
                };
                await saveAnnouncementToFirestore();
                elements.announcementModal.classList.add('hidden');
                displayAnnouncementBanner();
                showNotification('Announcement cleared', 'success');
            }
        }
        
        function displayAnnouncementBanner() {
            if (state.announcement.active && !state.announcement.dismissed && 
                state.announcement.title && state.announcement.message) {
                elements.announcementBannerTitle.textContent = state.announcement.title;
                elements.announcementBannerMessage.textContent = state.announcement.message;
                elements.announcementBanner.classList.remove('hidden');
                feather.replace();
            } else {
                elements.announcementBanner.classList.add('hidden');
            }
        }
        
        function dismissAnnouncementBanner() {
            state.announcement.dismissed = true;
            elements.announcementBanner.classList.add('hidden');
        }
        // Show loading overlay
        function showLoading() {
            elements.loadingOverlay.classList.remove('hidden');
        }
        
        // Hide loading overlay
        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
        }
        
        // Update sync status
        function updateSyncStatus(synced) {
            if (synced) {
                elements.syncStatus.textContent = '● Synced';
                elements.syncStatus.className = 'text-xs text-green-600 ml-2';
            } else {
                elements.syncStatus.textContent = '● Syncing...';
                elements.syncStatus.className = 'text-xs text-yellow-600 ml-2';
            }
        }

        // Load all data from Firestore - OPTIMIZED
        async function loadDataFromFirestore() {
            try {
                showLoading();
                updateSyncStatus(false);
                
                // Load all data in parallel for better performance
                const [students, events, paidLessons, studentNotes, settings] = await Promise.all([
                    FirebaseService.loadStudents(),
                    FirebaseService.loadEvents(),
                    FirebaseService.loadPaidLessons(),
                    FirebaseService.loadStudentNotes(),
                    FirebaseService.loadSettings()
                ]);
                
                // Update state
                state.students = students;
                state.events = events;
                state.paidLessons = paidLessons;
                state.studentNotes = studentNotes;
                
                // Apply theme settings
                if (settings.isDarkMode) {
                    state.isDarkMode = true;
                    document.documentElement.classList.add('dark');
                    elements.themeToggle.innerHTML = '<i data-feather="sun" class="text-yellow-400 w-4 h-4"></i>';
                }
                
                // Load announcement
                await loadAnnouncementFromFirestore();
                
                console.log('Data loaded from Firestore successfully!');
                updateSyncStatus(true);
                hideLoading();
                
            } catch (error) {
                console.error('Error loading data from Firestore:', error);
                showNotification('Failed to load data. Please refresh the page.', 'error');
                hideLoading();
                updateSyncStatus(true);
            }
        }
        
        // Save student to Firestore
        async function saveStudentToFirestore(student) {
            try {
                updateSyncStatus(false);
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.db, 'students', student.id), {
                    name: student.name,
                    rate: student.rate,
                    accessCode: student.accessCode || null  // NEW: Include access code
                });
                console.log('Student saved to Firestore:', student.id);
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error saving student:', error);
                alert('Failed to save student to Firestore.');
                updateSyncStatus(true);
            }
        }
        
        // Delete student from Firestore
        async function deleteStudentFromFirestore(studentId) {
            try {
                updateSyncStatus(false);
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.db, 'students', studentId));
                await deleteDoc(doc(window.db, 'paidLessons', studentId));
                await deleteDoc(doc(window.db, 'studentNotes', studentId));
                console.log('Student deleted from Firestore:', studentId);
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error deleting student:', error);
                updateSyncStatus(true);
            }
        }
        
        // Save event to Firestore
        async function saveEventToFirestore(event) {
            try {
                updateSyncStatus(false);
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.db, 'events', event.id), {
                    date: event.date,
                    time: event.time,
                    studentId: event.studentId,
                    notes: event.notes || ''
                });
                console.log('Event saved to Firestore:', event.id);
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error saving event:', error);
                alert('Failed to save event to Firestore.');
                updateSyncStatus(true);
            }
        }
        
        // Delete event from Firestore
        async function deleteEventFromFirestore(eventId) {
            try {
                updateSyncStatus(false);
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.db, 'events', eventId));
                console.log('Event deleted from Firestore:', eventId);
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error deleting event:', error);
                updateSyncStatus(true);
            }
        }
        
        // Save paid lessons to Firestore
        async function savePaidLessonsToFirestore(studentId, count) {
            try {
                updateSyncStatus(false);
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.db, 'paidLessons', studentId), {
                    count: count
                });
                console.log('Paid lessons saved to Firestore:', studentId);
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error saving paid lessons:', error);
                updateSyncStatus(true);
            }
        }
        
        // Save student notes to Firestore
        async function saveStudentNotesToFirestore(studentId, notes) {
            try {
                updateSyncStatus(false);
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.db, 'studentNotes', studentId), {
                    notes: notes
                });
                console.log('Student notes saved to Firestore:', studentId);
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error saving student notes:', error);
                updateSyncStatus(true);
            }
        }
        
        // Save app settings to Firestore
        async function saveSettingsToFirestore() {
            try {
                updateSyncStatus(false);
                const { doc, setDoc } = window.firestoreModules;
                await setDoc(doc(window.db, 'settings', 'appSettings'), {
                    isDarkMode: state.isDarkMode
                });
                console.log('Settings saved to Firestore');
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error saving settings:', error);
                updateSyncStatus(true);
            }
        }
// ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Format date string consistently
        function formatDateString(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }
        
        // Get current month string
        function getCurrentMonthString() {
            return formatDateString(state.currentYear, state.currentMonth + 1, 1).substring(0, 7);
        }
        
        // Check if current user is admin
        function isAdmin() {
            return state.currentUser?.role === 'admin';
        }
        
        // Check if current user can view specific student
        function canViewStudent(studentId) {
            if (!state.currentUser) return false;
            if (isAdmin()) return true;
            return state.currentUser.studentId === studentId;
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }
        
        // Generate unique ID
        function generateUniqueId() {
            return Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Safe element update
        function safeUpdateElement(element, content, property = 'textContent') {
            if (element) {
                element[property] = content;
            } else {
                console.warn('Element not found for update');
            }
        }
        
        // Show temporary notification
        function showNotification(message, type = 'success', duration = CONFIG.NOTIFICATION_DURATION) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            } text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, duration);
        }
        
        // Validate student data
        function validateStudentData(name, rate) {
            const errors = [];
            
            if (!name || name.trim().length === 0) {
                errors.push('Student name is required');
            }
            if (name && name.trim().length > CONFIG.MAX_STUDENT_NAME_LENGTH) {
                errors.push(`Student name is too long (max ${CONFIG.MAX_STUDENT_NAME_LENGTH} characters)`);
            }
            if (isNaN(rate) || rate <= 0) {
                errors.push('Rate must be a positive number');
            }
            if (rate > CONFIG.MAX_RATE) {
                errors.push('Rate is unreasonably high');
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }
        
        // Validate event data
        function validateEventData(date, time, studentId) {
            const errors = [];
            
            if (!date) errors.push('Date is required');
            if (!time) errors.push('Time is required');
            if (!studentId) errors.push('Student selection is required');
            
            if (studentId && !state.students.find(s => s.id === studentId)) {
                errors.push('Selected student does not exist');
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }
        
        // Get filtered events for current user
        function getFilteredEvents(events) {
            if (!state.currentUser || isAdmin()) {
                return events;
            }
            return events.filter(e => e.studentId === state.currentUser.studentId);
        }
        
        // Get filtered students for current user
        function getFilteredStudents() {
            if (!state.currentUser || isAdmin()) {
                return state.students;
            }
            return state.students.filter(s => s.id === state.currentUser.studentId);
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        // Check if user is already logged in
        function checkExistingAuth() {
            const savedAuth = localStorage.getItem('eduCalendarAuth');
            if (savedAuth) {
                try {
                    const authData = JSON.parse(savedAuth);
                    state.currentUser = authData;
                    state.isAuthenticated = true;
                    return true;
                } catch (e) {
                    localStorage.removeItem('eduCalendarAuth');
                    return false;
                }
            }
            return false;
        }
        
        // Validate login code - OPTIMIZED
function validateLoginCode(code) {
    if (!code || typeof code !== 'string') {
        return { valid: false, error: 'Invalid code format' };
    }
    
    const trimmedCode = code.trim();
    
    // Check if it's admin code
    if (trimmedCode === CONFIG.ADMIN_CODE) {
        return { 
            valid: true, 
            role: 'admin', 
            code: trimmedCode 
        };
    }
    
    // Check if it's a student code
    const student = state.students.find(s => s.accessCode === trimmedCode);
    if (student) {
        return { 
            valid: true, 
            role: 'student', 
            code: trimmedCode, 
            studentId: student.id,
            studentName: student.name 
        };
    }
    
    return { 
        valid: false, 
        error: 'Code not found' 
    };
}
        
    // Handle login - OPTIMIZED
async function handleLogin() {
    const code = elements.loginCode.value.trim();
    const keepLoggedIn = elements.keepLoggedIn.checked;
    
    // Validation
    if (!code) {
        showLoginError('Please enter an access code');
        return;
    }
    
    // Show loading state
    elements.loginBtn.disabled = true;
    elements.loginBtn.textContent = 'Signing in...';
    
    try {
        const validation = validateLoginCode(code);
        
        if (!validation.valid) {
            showLoginError(validation.error || 'Invalid access code. Please try again.');
            elements.loginCode.value = '';
            return;
        }
        
        // Set authentication state
        state.isAuthenticated = true;
        state.currentUser = {
            role: validation.role,
            code: validation.code,
            studentId: validation.studentId,
            studentName: validation.studentName
        };
        
        // Save to localStorage if "keep logged in" is checked
        if (keepLoggedIn) {
            try {
                localStorage.setItem('eduCalendarAuth', JSON.stringify(state.currentUser));
            } catch (e) {
                console.error('Failed to save login state:', e);
            }
        }
        
        // Show app, hide login
        elements.loginPage.classList.add('hidden');
        elements.appContent.classList.remove('hidden');
        
        // Update UI based on role
        updateUIForRole();
        
        // Initialize app
        await init();
        
    } catch (error) {
        console.error('Login error:', error);
        showLoginError('An error occurred during login. Please try again.');
    } finally {
        // Reset button state
        elements.loginBtn.disabled = false;
        elements.loginBtn.textContent = 'Sign In';
    }
}
        
        // Show login error
        function showLoginError(message) {
            elements.loginError.textContent = message;
            elements.loginError.classList.remove('hidden');
            setTimeout(() => {
                elements.loginError.classList.add('hidden');
            }, CONFIG.NOTIFICATION_DURATION);
        }
        
        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                state.isAuthenticated = false;
                state.currentUser = null;
                localStorage.removeItem('eduCalendarAuth');
                
                // Hide app, show login
                elements.appContent.classList.add('hidden');
                elements.loginPage.classList.remove('hidden');
                elements.loginCode.value = '';
                elements.keepLoggedIn.checked = false;
            }
        }
        
        // Update UI based on user role
        function updateUIForRole() {
            const isAdmin = state.currentUser.role === 'admin';
            
            // Update role badge
            elements.userRoleBadge.textContent = isAdmin ? 'Admin' : 'Student';
            elements.userRoleBadge.className = isAdmin 
                ? 'text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded ml-2'
                : 'text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2';
            
            // Show/hide admin-only elements
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });
            
            // For students, hide the student management section
            if (!isAdmin) {
                const studentManagementSection = document.querySelector('.lg\\:col-span-1');
                if (studentManagementSection) {
                    studentManagementSection.style.display = 'none';
                }
                // Make calendar full width for students
                const calendarSection = document.querySelector('.lg\\:col-span-2');
                if (calendarSection) {
                    calendarSection.className = 'lg:col-span-3';
                }
            }
        }
        
        // Save student access code to Firestore
        async function saveStudentAccessCode(studentId, accessCode) {
            try {
                updateSyncStatus(false);
                const { doc, setDoc } = window.firestoreModules;
                const student = state.students.find(s => s.id === studentId);
                await setDoc(doc(window.db, 'students', studentId), {
                    name: student.name,
                    rate: student.rate,
                    accessCode: accessCode
                });
                console.log('Student access code saved:', studentId);
                updateSyncStatus(true);
            } catch (error) {
                console.error('Error saving student access code:', error);
                updateSyncStatus(true);
            }
        }
        
        // Generate random access code
        function generateAccessCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < CONFIG.ACCESS_CODE_LENGTH; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        // ============================================
// HELPER FUNCTIONS
// ============================================

// Filter data based on user role
function getFilteredData(dataArray, filterByStudent = false) {
    if (!state.currentUser || state.currentUser.role === 'admin') {
        return dataArray;
    }
    
    if (filterByStudent && state.currentUser.studentId) {
        return dataArray.filter(item => item.studentId === state.currentUser.studentId);
    }
    
    return dataArray;
}

// Check if current user can perform admin actions
function canPerformAdminAction() {
    return state.currentUser && state.currentUser.role === 'admin';
}

// Check if current user can view student data
function canViewStudent(studentId) {
    if (!state.currentUser) return false;
    if (state.currentUser.role === 'admin') return true;
    return state.currentUser.studentId === studentId;
}

// Safe element update with null check
function safeUpdateElement(elementId, content, property = 'textContent') {
    const element = document.getElementById(elementId);
    if (element) {
        element[property] = content;
    } else {
        console.warn(`Element ${elementId} not found`);
    }
}

// Escape HTML to prevent XSS attacks
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
}

// Validate student data before saving
function validateStudentData(name, rate) {
    const errors = [];
    
    if (!name || name.trim().length === 0) {
        errors.push('Student name is required');
    }
    if (name && name.trim().length > 100) {
        errors.push('Student name is too long (max 100 characters)');
    }
    if (isNaN(rate) || rate <= 0) {
        errors.push('Rate must be a positive number');
    }
    if (rate > 100000) {
        errors.push('Rate is unreasonably high');
    }
    
    return {
        valid: errors.length === 0,
        errors: errors
    };
}

// Validate event data before saving
function validateEventData(date, time, studentId) {
    const errors = [];
    
    if (!date) {
        errors.push('Date is required');
    }
    if (!time) {
        errors.push('Time is required');
    }
    if (!studentId) {
        errors.push('Student selection is required');
    }
    
    // Check if student exists
    if (studentId && !state.students.find(s => s.id === studentId)) {
        errors.push('Selected student does not exist');
    }
    
    return {
        valid: errors.length === 0,
        errors: errors
    };
}


        // ============================================
        // APP INITIALIZATION AND RENDERING
        // ============================================
        
        // Initialize the app
        async function init() {
            // Check authentication first
            if (!state.isAuthenticated) {
                const hasAuth = checkExistingAuth();
                if (hasAuth) {
                    elements.loginPage.classList.add('hidden');
                    elements.appContent.classList.remove('hidden');
                    updateUIForRole();
                } else {
                    // Show login page
                    elements.loginPage.classList.remove('hidden');
                    elements.appContent.classList.add('hidden');
                    feather.replace();
                    return; // Don't load data yet
                }
            }
            
            await loadDataFromFirestore();
            renderCalendar();
            renderStudentsList();
            renderStudentTotals();
            renderPaymentsList();
            setupEventListeners();
            feather.replace();
        }

        // Check if a lesson is paid - FIXED
function isLessonPaid(studentId, eventId) {
    const paidCount = state.paidLessons[studentId] || 0;
    const studentEvents = state.events
        .filter(e => e.studentId === studentId)
        .sort((a, b) => {
            const dateCompare = a.date.localeCompare(b.date);
            return dateCompare !== 0 ? dateCompare : a.time.localeCompare(b.time);
        });
    
    const eventIndex = studentEvents.findIndex(e => e.id === eventId);
    
    // If event not found or index is less than paid count, it's paid
    return eventIndex !== -1 && eventIndex < paidCount;
}

        // Get remaining paid lessons for a student
        function getRemainingLessons(studentId) {
            const paidCount = state.paidLessons[studentId] || 0;
            const scheduledCount = state.events.filter(e => e.studentId === studentId).length;
            return paidCount - scheduledCount;
        }

        // ============================================
        // RENDER SERVICE MODULE
        // ============================================
        
        const RenderService = {
            refreshAll() {
                this.calendar();
                this.students();
                this.payments();
                this.totals();
                feather.replace();
            },
            
            calendar() {
                renderCalendar();
            },
            
            students() {
                renderStudentsList();
            },
            
            payments() {
                renderPaymentsList();
            },
            
            totals() {
                renderStudentTotals();
            }
        };
        
        function renderPaymentsList() {
    elements.paymentsList.innerHTML = '';
    // Student view: Show balance for logged-in student only
    if (state.currentUser && state.currentUser.role === 'student' && state.currentUser.studentId) {
        const student = state.students.find(s => s.id === state.currentUser.studentId);
        if (student) {
            const paidLessons = state.paidLessons[student.id] || 0;
            const scheduledLessons = state.events.filter(e => e.studentId === student.id).length;
            const remainingLessons = paidLessons - scheduledLessons;
            
            const balanceCard = document.createElement('div');
            balanceCard.className = 'balance-card mb-6';
            balanceCard.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white bg-opacity-20 p-3 rounded-l g">
                            <i data-feather="credit-card" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">Paid Lessons Left</h3>
                            <p class="text-sm opacity-90">Your remaining lesson credits</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold">${remainingLessons}</div>
                        <div class="text-sm opacity-90">lessons</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 pt-4 border-t border-white border-opacity-20">
                    <div class="text-center">
                        <div class="text-2xl font-bold">${paidLessons}</div>
                        <div class="text-xs opacity-75">Paid</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">${scheduledLessons}</div>
                        <div class="text-xs opacity-75">Scheduled</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold ${remainingLessons < 0 ? 'text-red-300' : ''}">
                            ${remainingLessons < 0 ? '⚠️' : '✓'} ${Math.abs(remainingLessons)}
                        </div>
                        <div class="text-xs opacity-75">${remainingLessons < 0 ? 'Overdue' : 'Available'}</div>
                    </div>
                </div>
                ${remainingLessons <= 0 ? `
                <div class="mt-4 p-3 bg-red-500 bg-opacity-30 rounded-lg text-sm">
                    <strong>⚠️ Action Required:</strong> ${remainingLessons < 0 ? 'You have unpaid lessons. Please contact your teacher.' : 'No lesson credits remaining. Please add credits to continue scheduling.'}
                </div>
                ` : ''}
            `;
            elements.paymentsList.appendChild(balanceCard);
            feather.replace();
        }
    }
    
    // Use helper function for filtering
    const studentsToShow = state.currentUser && state.currentUser.role === 'student' 
        ? state.students.filter(s => s.id === state.currentUser.studentId)
        : state.students;
    
    if (studentsToShow.length === 0) {
        elements.paymentsList.innerHTML = '<p class="text-gray-500 text-center py-8">No students added yet</p>';
        return;
    }
    
    const isAdmin = canPerformAdminAction();
    
    // Create fragment for better performance
    const fragment = document.createDocumentFragment();
    
    studentsToShow.forEach(student => {
        const paidLessons = state.paidLessons[student.id] || 0;
        const scheduledLessons = state.events.filter(e => e.studentId === student.id).length;
        const remainingLessons = paidLessons - scheduledLessons;
        
        const paymentCard = document.createElement('div');
        paymentCard.className = 'border rounded-lg p-4';
        paymentCard.innerHTML = `
    <div class="flex justify-between items-start mb-3">
        <div>
            <h3 class="font-semibold text-lg">${escapeHtml(student.name)}</h3>
            <p class="text-sm text-gray-500">Rate: ${student.rate}/lesson</p>
            ${remainingLessons <= 0 ? '<p class="text-xs text-red-600 font-semibold mt-1">⚠️ No paid lessons remaining</p>' : ''}
        </div>
                <div class="text-right">
                    <div class="text-2xl font-bold ${remainingLessons < 0 ? 'text-red-600' : 'text-indigo-600'}">
                        ${remainingLessons}
                    </div>
                    <div class="text-xs text-gray-500">remaining</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                <div class="bg-green-50 p-2 rounded">
                    <div class="text-green-800 font-medium">Paid</div>
                    <div class="text-green-600 text-lg">${paidLessons}</div>
                </div>
                <div class="bg-blue-50 p-2 rounded">
                    <div class="text-blue-800 font-medium">Scheduled</div>
                    <div class="text-blue-600 text-lg">${scheduledLessons}</div>
                </div>
            </div>
            ${isAdmin ? `
            <div class="flex space-x-2">
                <input type="number" 
                       id="add-lessons-${student.id}" 
                       placeholder="Lessons" 
                       min="1"
                       class="flex-1 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                <button class="add-paid-lessons px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm"
                        data-student-id="${student.id}">
                    <i data-feather="plus" class="w-4 h-4"></i>
                </button>
            </div>` : ''}
        `;
        fragment.appendChild(paymentCard);
    });
    
    elements.paymentsList.appendChild(fragment);
    feather.replace();
    
    // Add event listeners only for admin
    if (isAdmin) {
        attachPaymentListeners();
    }
}

// Separate function for payment listeners
function attachPaymentListeners() {
    document.querySelectorAll('.add-paid-lessons').forEach(btn => {
        btn.addEventListener('click', async () => {
            const studentId = btn.dataset.studentId;
            const input = document.getElementById(`add-lessons-${studentId}`);
            const lessons = parseInt(input.value);
            
            if (lessons && lessons > 0) {
                try {
                    state.paidLessons[studentId] = (state.paidLessons[studentId] || 0) + lessons;
                    await savePaidLessonsToFirestore(studentId, state.paidLessons[studentId]);
                    input.value = '';
                    renderPaymentsList();
                    renderCalendar();
                } catch (error) {
                    console.error('Error adding paid lessons:', error);
                    alert('Failed to add lessons. Please try again.');
                }
            }
        });
    });
}
        
        // Render the calendar - OPTIMIZED
        function renderCalendar() {
            elements.calendarGrid.innerHTML = '';
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];
            elements.currentMonthDisplay.textContent = `${monthNames[state.currentMonth]} ${state.currentYear}`;
            
            const firstDay = new Date(state.currentYear, state.currentMonth, 1).getDay();
            const daysInMonth = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            
            const fragment = document.createDocumentFragment();
            
            // Add empty cells
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-24 bg-gray-50 rounded-lg';
                fragment.appendChild(emptyDay);
            }
            
            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                fragment.appendChild(createDayElement(day));
            }
            
            elements.calendarGrid.appendChild(fragment);
        }

     // Create individual day element - HELPER
        function createDayElement(day) {
            const dateStr = formatDateString(state.currentYear, state.currentMonth + 1, day);
            
            // Filter events based on role
            let dayEvents = state.events.filter(event => event.date === dateStr);
            dayEvents = getFilteredEvents(dayEvents);
            dayEvents.sort((a, b) => a.time.localeCompare(b.time));
            
            const dayElement = document.createElement('div');
            dayElement.className = 'h-24 border rounded-lg calendar-day overflow-hidden cursor-pointer transition';
            
            const adminRole = isAdmin();
            const eventsHtml = dayEvents.map(event => {
                const student = state.students.find(s => s.id === event.studentId);
                const isPaid = isLessonPaid(event.studentId, event.id);
                const studentName = adminRole && student ? ` - ${escapeHtml(student.name)}` : '';
                
                return `
                    <div class="text-xs p-1 ${isPaid ? 'bg-indigo-100 text-indigo-800' : 'bg-red-100 text-red-800 unpaid-event'} rounded truncate hover:bg-indigo-200 cursor-pointer" 
                         data-event-id="${event.id}">
                        ${event.time}${studentName}
                    </div>
                `;
            }).join('');
            
            dayElement.innerHTML = `
                <div class="p-2 h-full flex flex-col">
                    <div class="text-right font-medium">${day}</div>
                    <div class="flex-1 overflow-y-auto mt-1 space-y-1">
                        ${eventsHtml}
                    </div>
                </div>
            `;
            
            dayElement.addEventListener('click', (e) => handleDayClick(e, day));
            
            return dayElement;
        }
        
        // Handle day click events - HELPER
        function handleDayClick(e, day) {
            const eventElement = e.target.closest('[data-event-id]');
            
            if (eventElement) {
                e.stopPropagation();
                const eventId = eventElement.dataset.eventId;
                const event = state.events.find(ev => ev.id === eventId);
                
                if (event) {
                    if (state.currentUser.role === 'student') {
                        openEventDetailView(event);
                    } else {
                        openEditEventModal(event);
                    }
                }
            } else {
                if (isAdmin()) {
                    openDayView(day, state.currentMonth + 1, state.currentYear);
                }
            }
        }

// Separate function to create day elements
function createDayElement(day) {
    const dateStr = `${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    // Check if this is today's date
    const today = new Date();
    const isToday = day === today.getDate() && 
                    state.currentMonth === today.getMonth() && 
                    state.currentYear === today.getFullYear(); 
    // Filter events based on role
    let dayEvents = state.events.filter(event => event.date === dateStr);
    if (state.currentUser && state.currentUser.role === 'student' && state.currentUser.studentId) {
        dayEvents = dayEvents.filter(event => event.studentId === state.currentUser.studentId);
    }
    dayEvents.sort((a, b) => a.time.localeCompare(b.time));
    
    const dayElement = document.createElement('div');
    dayElement.className = `h-24 border rounded-lg calendar-day overflow-hidden cursor-pointer transition${isToday ? ' current-day' : ''}`;

    const isAdmin = canPerformAdminAction();
    const eventsHtml = dayEvents.map(event => {
        const student = state.students.find(s => s.id === event.studentId);
        const isPaid = isLessonPaid(event.studentId, event.id);
        const studentName = isAdmin && student ? ` - ${escapeHtml(student.name)}` : '';
        
        return `
            <div class="text-xs p-1 ${isPaid ? 'bg-indigo-100 text-indigo-800' : 'bg-red-100 text-red-800 unpaid-event'} rounded truncate hover:bg-indigo-200 cursor-pointer" 
                 data-event-id="${event.id}">
                ${event.time}${studentName}
            </div>
        `;
    }).join('');
    
    dayElement.innerHTML = `
        <div class="p-2 h-full flex flex-col">
            <div class="text-right font-medium">${day}</div>
            <div class="flex-1 overflow-y-auto mt-1 space-y-1">
                ${eventsHtml}
            </div>
        </div>
    `;
    
    // Add event listener
    dayElement.addEventListener('click', (e) => handleDayClick(e, day));
    
    return dayElement;
}

// Handle day click events
function handleDayClick(e, day) {
    const eventElement = e.target.closest('[data-event-id]');
    
    if (eventElement) {
        e.stopPropagation();
        const eventId = eventElement.dataset.eventId;
        const event = state.events.find(ev => ev.id === eventId);
        
        if (event) {
            if (state.currentUser.role === 'student') {
                openEventDetailView(event);
            } else {
                openEditEventModal(event);
            }
        }
    } else {
        // Only admins can add new events
        if (canPerformAdminAction()) {
            openDayView(day, state.currentMonth + 1, state.currentYear);
        }
    }
}

       // Render students list - OPTIMIZED
        function renderStudentsList() {
            elements.studentsList.innerHTML = '';
            
            if (state.students.length === 0) {
                elements.studentsList.innerHTML = '<p class="text-gray-500 text-center py-8">No students yet</p>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            state.students.forEach(student => {
                fragment.appendChild(createStudentCard(student));
            });
            
            elements.studentsList.appendChild(fragment);
            feather.replace();
            attachStudentListeners();
        }

// Create individual student card
function createStudentCard(student) {
    const studentElement = document.createElement('div');
    studentElement.className = 'bg-white border rounded-lg p-3 student-card transition cursor-pointer';
    studentElement.dataset.studentId = student.id;
    
    studentElement.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <div>
                <h3 class="font-medium">${escapeHtml(student.name)}</h3>
                <p class="text-sm text-gray-500">₴${student.rate}/session</p>
            </div>
            <div class="flex space-x-2">
                <button class="p-1 text-green-600 hover:text-green-800 notes-student" data-id="${student.id}" title="Student Notes">
                    <i data-feather="file-text" class="w-4 h-4"></i>
                </button>
                <button class="p-1 text-indigo-600 hover:text-indigo-800 edit-student" data-id="${student.id}" title="Edit Student">
                    <i data-feather="edit-2" class="w-4 h-4"></i>
                </button>
                <button class="p-1 text-red-600 hover:text-red-800 delete-student" data-id="${student.id}" title="Delete Student">
                    <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
                <button class="p-1 text-gray-600 hover:text-gray-800 filter-student" data-id="${student.id}" title="Filter by Student">
                    <i data-feather="filter" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <div class="mt-2 pt-2 border-t">
            <div class="flex items-center justify-between">
                <span class="text-xs text-gray-500">Access Code:</span>
                <div class="flex items-center space-x-1">
                    <code class="text-xs bg-gray-100 px-2 py-1 rounded" id="code-${student.id}">
                        ${student.accessCode || 'Not set'}
                    </code>
                    <button class="p-1 text-blue-600 hover:text-blue-800 generate-code" data-id="${student.id}" title="Generate Code">
                        <i data-feather="refresh-cw" class="w-3 h-3"></i>
                    </button>
                    ${student.accessCode ? `
                    <button class="p-1 text-gray-600 hover:text-gray-800 copy-code" data-id="${student.id}" title="Copy Code">
                        <i data-feather="copy" class="w-3 h-3"></i>
                    </button>` : ''}
                </div>
            </div>
        </div>
    `;
    
    return studentElement;
}
// Attach all student-related event listeners
function attachStudentListeners() {
    // Notes button
    document.querySelectorAll('.notes-student').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            openStudentNotesModal(btn.dataset.id);
        });
    });
    
    // Edit button
    document.querySelectorAll('.edit-student').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            editStudent(btn.dataset.id);
        });
    });
    
    // Delete button
    document.querySelectorAll('.delete-student').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteStudent(btn.dataset.id);
        });
    });
    
    // Filter button
    document.querySelectorAll('.filter-student').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            filterByStudent(btn.dataset.id);
        });
    });
    
    // Generate code button
    document.querySelectorAll('.generate-code').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            await handleGenerateCode(btn.dataset.id);
        });
    });
    
    // Copy code button
    document.querySelectorAll('.copy-code').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            await handleCopyCode(btn.dataset.id);
        });
    });
    
    // Card click
    document.querySelectorAll('.student-card').forEach(card => {
        card.addEventListener('click', () => {
            const studentId = card.dataset.studentId;
            state.selectedStudent = state.students.find(s => s.id === studentId);
            renderStudentTotals();
        });
    });
}

// Handle generate code action
async function handleGenerateCode(studentId) {
    const student = state.students.find(s => s.id === studentId);
    if (!student) return;
    
    try {
        const newCode = generateAccessCode();
        student.accessCode = newCode;
        await saveStudentAccessCode(studentId, newCode);
        renderStudentsList();
    } catch (error) {
        console.error('Error generating code:', error);
        alert('Failed to generate code. Please try again.');
    }
}

// Handle copy code action
async function handleCopyCode(studentId) {
    const student = state.students.find(s => s.id === studentId);
    if (!student || !student.accessCode) return;
    
    try {
        await navigator.clipboard.writeText(student.accessCode);
        const codeElement = document.getElementById(`code-${studentId}`);
        if (codeElement) {
            const originalText = codeElement.textContent;
            codeElement.textContent = 'Copied!';
            codeElement.classList.add('text-green-600');
            setTimeout(() => {
                codeElement.textContent = originalText;
                codeElement.classList.remove('text-green-600');
            }, 1500);
        }
    } catch (error) {
        console.error('Error copying code:', error);
        alert('Failed to copy code to clipboard.');
    }
}

        // Open student notes modal
        function openStudentNotesModal(studentId) {
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;
            
            state.selectedStudent = student;
            elements.notesModalTitle.textContent = `Notes for ${student.name}`;
            elements.studentNotesTextarea.value = state.studentNotes[studentId] || '';
            elements.notesModal.classList.remove('hidden');
            feather.replace();
        }

        // Save student notes
        async function saveStudentNotes() {
            if (state.selectedStudent) {
                state.studentNotes[state.selectedStudent.id] = elements.studentNotesTextarea.value;
                await saveStudentNotesToFirestore(state.selectedStudent.id, elements.studentNotesTextarea.value);
                elements.notesModal.classList.add('hidden');
            }
        }

        // Render student financial totals - FIXED to exclude unpaid lessons
function renderStudentTotals() {
    // Hide financial summary for student users
    if (state.currentUser && state.currentUser.role === 'student') {
        const financialSummary = document.querySelector('.mt-6.bg-white.rounded-xl.shadow-md.p-6');
        if (financialSummary && financialSummary.querySelector('#student-totals')) {
            financialSummary.style.display = 'none';
        }
        return;
    }
    
    elements.studentTotals.innerHTML = '';
    
    let monthTotal = 0;
    const monthStr = `${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}`;
    
    // Filter students for student role
    let studentsToShow = state.students;
    
    studentsToShow.forEach(student => {
        const studentEvents = state.events.filter(event => 
            event.studentId === student.id && event.date.startsWith(monthStr)
        );
        
        // Count only PAID lessons for financial summary
        const paidLessonsCount = studentEvents.filter(event => 
            isLessonPaid(student.id, event.id)
        ).length;
        
        const studentTotal = paidLessonsCount * student.rate;
        monthTotal += studentTotal;
        
        const totalElement = document.createElement('div');
        totalElement.className = `flex justify-between items-center p-2 rounded-lg ${state.selectedStudent && state.selectedStudent.id === student.id ? 'bg-indigo-50' : ''}`;
        totalElement.innerHTML = `
            <span>${escapeHtml(student.name)}</span>
            <span class="font-medium">₴${studentTotal.toFixed(2)}</span>
        `;
        
        totalElement.addEventListener('click', () => {
            state.selectedStudent = student;
            renderStudentTotals();
        });
        
        elements.studentTotals.appendChild(totalElement);
    });
    
    elements.monthTotal.textContent = `₴${monthTotal.toFixed(2)}`;
}

        // Open day view showing all events for a specific day
        function openDayView(day, month, year) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            state.selectedDate = dateStr;
            
            const dayEvents = state.events.filter(event => event.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
            
            const date = new Date(dateStr);
            elements.dayViewTitle.textContent = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.dayViewContent.innerHTML = '';
            
            if (dayEvents.length === 0) {
                elements.dayViewContent.innerHTML = '<p class="text-gray-500 text-center py-8">No events scheduled for this day</p>';
            } else {
                dayEvents.forEach(event => {
                    const student = state.students.find(s => s.id === event.studentId);
                    const isPaid = isLessonPaid(event.studentId, event.id);
                    const eventCard = document.createElement('div');
                    eventCard.className = `border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition ${!isPaid ? 'border-red-300 bg-red-50' : ''}`;
                    eventCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-semibold ${isPaid ? 'text-indigo-600' : 'text-red-600'}">${event.time}</span>
                                    <span class="text-gray-400">•</span>
                                    <span class="font-medium">${student ? student.name : 'Unknown'}</span>
                                    ${!isPaid ? '<span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded">UNPAID</span>' : ''}
                                </div>
                                ${event.notes ? `<p class="text-sm text-gray-600">${event.notes}</p>` : ''}
                                ${!isPaid ? '<p class="text-xs text-red-600 font-semibold mt-1">⚠️ This lesson is not paid</p>' : ''}
                                ${student ? `<p class="text-xs text-gray-500 mt-1">Rate: ${student.rate}</p>` : ''}
                            </div>
                            <div class="flex space-x-1">
                                <button class="p-2 text-indigo-600 hover:bg-indigo-50 rounded edit-day-event" data-event-id="${event.id}">
                                    <i data-feather="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button class="p-2 text-red-600 hover:bg-red-50 rounded delete-day-event" data-event-id="${event.id}">
                                    <i data-feather="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    elements.dayViewContent.appendChild(eventCard);
                });
                
                feather.replace();
                
                document.querySelectorAll('.edit-day-event').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const eventId = btn.dataset.eventId;
                        const event = state.events.find(ev => ev.id === eventId);
                        if (event) {
                            elements.dayViewModal.classList.add('hidden');
                            openEditEventModal(event);
                        }
                    });
                });
                
                document.querySelectorAll('.delete-day-event').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const eventId = btn.dataset.eventId;
                        if (confirm('Are you sure you want to delete this event?')) {
                            state.events = state.events.filter(e => e.id !== eventId);
                            await deleteEventFromFirestore(eventId);
                            renderCalendar();
                            renderStudentTotals();
                            renderPaymentsList();
                            openDayView(day, month, year);
                        }
                    });
                });
            }
            
            elements.dayViewModal.classList.remove('hidden');
            feather.replace();
        }
        // Open today's events
function openTodayView() {
    const today = new Date();
    openDayView(today.getDate(), today.getMonth() + 1, today.getFullYear());
}

        // Open event detail view (read-only for students)
        function openEventDetailView(event) {
            const student = state.students.find(s => s.id === event.studentId);
            const isPaid = isLessonPaid(event.studentId, event.id);
            
            const date = new Date(event.date);
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            alert(`Lesson Details\n\nDate: ${dateStr}\nTime: ${event.time}\nStatus: ${isPaid ? 'Paid' : 'Unpaid'}\n${event.notes ? 'Notes: ' + event.notes : ''}`);
        }

        // Open event modal
        function openEventModal(day, month, year) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            state.selectedDate = dateStr;
            state.editingEventId = null;
            
            elements.eventTimeSelect.innerHTML = '';
            for (let hour = 8; hour <= 20; hour++) {
                const time = `${String(hour).padStart(2, '0')}:00`;
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                elements.eventTimeSelect.appendChild(option);
            }
            
            elements.eventStudentSelect.innerHTML = '';
            state.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                elements.eventStudentSelect.appendChild(option);
            });
            
            elements.eventTimeSelect.value = '08:00';
            elements.eventStudentSelect.value = '';
            elements.eventNotesInput.value = '';
            elements.deleteEventBtn.classList.add('hidden');
            
            elements.eventDateInput.value = new Date(dateStr).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.eventModal.classList.remove('hidden');
            feather.replace();
        }

        // Open event modal for editing
        function openEditEventModal(event) {
            state.selectedDate = event.date;
            state.editingEventId = event.id;
            
            elements.eventTimeSelect.innerHTML = '';
            for (let hour = 8; hour <= 20; hour++) {
                const time = `${String(hour).padStart(2, '0')}:00`;
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                elements.eventTimeSelect.appendChild(option);
            }
            
            elements.eventStudentSelect.innerHTML = '';
            state.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                elements.eventStudentSelect.appendChild(option);
            });
            
            elements.eventTimeSelect.value = event.time;
            elements.eventStudentSelect.value = event.studentId;
            elements.eventNotesInput.value = event.notes || '';
            elements.deleteEventBtn.classList.remove('hidden');
            elements.deleteEventBtn.dataset.eventId = event.id;
            
            elements.eventDateInput.value = new Date(event.date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.eventModal.classList.remove('hidden');
            feather.replace();
        }

        // Setup event listeners
        function setupEventListeners() {
             
            elements.prevMonthBtn.addEventListener('click', () => {
    if (state.currentMonth === 0) {
        state.currentMonth = 11;
        state.currentYear--;
    } else {
        state.currentMonth--;
    }
    renderCalendar();
    renderStudentTotals();
    feather.replace(); // Add this
});

elements.nextMonthBtn.addEventListener('click', () => {
    if (state.currentMonth === 11) {
        state.currentMonth = 0;
        state.currentYear++;
    } else {
        state.currentMonth++;
    }
    renderCalendar();
    renderStudentTotals();
    feather.replace(); // Add this
});
            
            elements.addStudentBtn.addEventListener('click', addStudent);
            elements.newEventBtn.addEventListener('click', () => {
                const today = new Date();
                openEventModal(today.getDate(), today.getMonth() + 1, today.getFullYear());
            });
            
            elements.closeModalBtn.addEventListener('click', () => {
                elements.eventModal.classList.add('hidden');
            });
            
            elements.saveEventBtn.addEventListener('click', saveEvent);
            elements.deleteEventBtn.addEventListener('click', deleteEvent);
            
            elements.closeDayViewBtn.addEventListener('click', () => {
                elements.dayViewModal.classList.add('hidden');
            });
            
            elements.addEventFromDayViewBtn.addEventListener('click', () => {
                elements.dayViewModal.classList.add('hidden');
                const dateParts = state.selectedDate.split('-');
                openEventModal(parseInt(dateParts[2]), parseInt(dateParts[1]), parseInt(dateParts[0]));
            });
            
            elements.closeNotesModal.addEventListener('click', () => {
                elements.notesModal.classList.add('hidden');
            });
            
            elements.saveStudentNotes.addEventListener('click', saveStudentNotes);
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            elements.studentsTab.addEventListener('click', () => {
                elements.studentsTab.classList.add('active');
                elements.paymentsTab.classList.remove('active');
                elements.studentsContent.classList.remove('hidden');
                elements.paymentsContent.classList.add('hidden');
                feather.replace();
            });
            
            elements.paymentsTab.addEventListener('click', () => {
                elements.paymentsTab.classList.add('active');
                elements.studentsTab.classList.remove('active');
                elements.paymentsContent.classList.remove('hidden');
                elements.studentsContent.classList.add('hidden');
                feather.replace();
            });
            
            elements.copyWeekBtn.addEventListener('click', () => {
                const today = new Date();
                elements.copyFromDate.value = today.toISOString().split('T')[0];
                elements.copyToDate.value = today.toISOString().split('T')[0];
                elements.copyModal.classList.remove('hidden');
            });
            
            elements.closeCopyModal.addEventListener('click', () => {
                elements.copyModal.classList.add('hidden');
            });
            
            elements.cancelCopy.addEventListener('click', () => {
                elements.copyModal.classList.add('hidden');
            });
            
            elements.executeCopy.addEventListener('click', executeCopyEvents);
            // Announcement listeners
            elements.announcementBtn.addEventListener('click', openAnnouncementModal);
            elements.closeAnnouncementModal.addEventListener('click', () => {
                elements.announcementModal.classList.add('hidden');
            });
            elements.saveAnnouncement.addEventListener('click', saveAnnouncement);
            elements.deleteAnnouncement.addEventListener('click', deleteAnnouncement);
            elements.closeAnnouncementBanner.addEventListener('click', dismissAnnouncementBanner);
            elements.todayBtn.addEventListener('click', openTodayView);
        }

        // Execute copy events
        async function executeCopyEvents() {
            const copyType = elements.copyType.value;
            const fromDate = new Date(elements.copyFromDate.value);
            const toDate = new Date(elements.copyToDate.value);
            
            if (!elements.copyFromDate.value || !elements.copyToDate.value) {
                alert('Please select both from and to dates');
                return;
            }
            
            let eventsToCopy = [];
            let newEvents = [];
            
            if (copyType === 'week') {
                const fromWeekStart = new Date(fromDate);
                fromWeekStart.setDate(fromDate.getDate() - fromDate.getDay());
                
                const fromWeekEnd = new Date(fromWeekStart);
                fromWeekEnd.setDate(fromWeekStart.getDate() + 6);
                
                eventsToCopy = state.events.filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate >= fromWeekStart && eventDate <= fromWeekEnd;
                });
                
                const dayDiff = Math.floor((toDate - fromDate) / (1000 * 60 * 60 * 24));
                const weekDiff = Math.floor(dayDiff / 7) * 7;
                
                for (const event of eventsToCopy) {
                    const eventDate = new Date(event.date);
                    const newDate = new Date(eventDate);
                    newDate.setDate(eventDate.getDate() + weekDiff);
                    
                    const newDateStr = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}-${String(newDate.getDate()).padStart(2, '0')}`;
                    
                    const exists = state.events.find(e => e.date === newDateStr && e.time === event.time);
                    if (!exists) {
                        const newEvent = {
                            id: Date.now().toString() + Math.random(),
                            date: newDateStr,
                            time: event.time,
                            studentId: event.studentId,
                            notes: event.notes
                        };
                        state.events.push(newEvent);
                        newEvents.push(newEvent);
                    }
                }
                
              } else if (copyType === 'month') {
                const fromMonth = fromDate.getMonth();
                const fromYear = fromDate.getFullYear();
                const monthStr = `${fromYear}-${String(fromMonth + 1).padStart(2, '0')}`;
                
                eventsToCopy = state.events.filter(event => event.date.startsWith(monthStr));
                
                const toMonth = toDate.getMonth();
                const toYear = toDate.getFullYear();
                const monthDiff = (toYear - fromYear) * 12 + (toMonth - fromMonth);
                
                for (const event of eventsToCopy) {
                    const eventDate = new Date(event.date);
                    const newDate = new Date(eventDate);
                    newDate.setMonth(eventDate.getMonth() + monthDiff);
                    
                    if (newDate.getMonth() === (eventDate.getMonth() + monthDiff + 12) % 12) {
                        const newDateStr = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}-${String(newDate.getDate()).padStart(2, '0')}`;
                        
                        const exists = state.events.find(e => e.date === newDateStr && e.time === event.time);
                        if (!exists) {
                            const newEvent = {
                                id: Date.now().toString() + Math.random(),
                                date: newDateStr,
                                time: event.time,
                                studentId: event.studentId,
                                notes: event.notes
                            };
                            state.events.push(newEvent);
                            newEvents.push(newEvent);
                        }
                    }
                }
            }
            
            // Save all new events to Firestore
            for (const event of newEvents) {
                await saveEventToFirestore(event);
            }
            
            elements.copyModal.classList.add('hidden');
            renderCalendar();
            renderStudentTotals();
            renderPaymentsList();
            alert(`Successfully copied ${newEvents.length} events!`);
        }

        // Add a new student - OPTIMIZED
async function addStudent() {
    const name = elements.studentNameInput.value.trim();
    const rate = parseFloat(elements.studentRateInput.value);
    
    // Validate input
    const validation = validateStudentData(name, rate);
    if (!validation.valid) {
        alert('Cannot add student:\n' + validation.errors.join('\n'));
        return;
    }
    
    // Disable button during save
    elements.addStudentBtn.disabled = true;
    
    try {
        const newStudent = {
            id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
            name: name,
            rate: rate,
            accessCode: null
        };
        
        state.students.push(newStudent);
        state.paidLessons[newStudent.id] = 0;
        state.studentNotes[newStudent.id] = '';
        
        // Save to Firestore
        await Promise.all([
            saveStudentToFirestore(newStudent),
            savePaidLessonsToFirestore(newStudent.id, 0),
            saveStudentNotesToFirestore(newStudent.id, '')
        ]);
        
        // Clear inputs
        elements.studentNameInput.value = '';
        elements.studentRateInput.value = '';
        
        // Re-render
        renderStudentsList();
        renderStudentTotals();
        renderPaymentsList();
        
    } catch (error) {
        console.error('Error adding student:', error);
        alert('Failed to add student. Please try again.');
        // Rollback
        state.students = state.students.filter(s => s.id !== newStudent.id);
    } finally {
        elements.addStudentBtn.disabled = false;
    }
}

        // Edit a student - OPTIMIZED
async function editStudent(studentId) {
    const student = state.students.find(s => s.id === studentId);
    if (!student) {
        console.error('Student not found:', studentId);
        return;
    }
    
    const newName = prompt("Edit student name:", student.name);
    if (newName === null) return; // User cancelled
    
    const newRateStr = prompt("Edit student rate:", student.rate);
    if (newRateStr === null) return; // User cancelled
    
    const newRate = parseFloat(newRateStr);
    
    // Validate
    const validation = validateStudentData(newName.trim(), newRate);
    if (!validation.valid) {
        alert('Invalid data:\n' + validation.errors.join('\n'));
        return;
    }
    
    // Store old values for rollback
    const oldName = student.name;
    const oldRate = student.rate;
    
    try {
        student.name = newName.trim();
        student.rate = newRate;
        
        await saveStudentToFirestore(student);
        renderStudentsList();
        renderStudentTotals();
        renderPaymentsList();
    } catch (error) {
        console.error('Error editing student:', error);
        // Rollback
        student.name = oldName;
        student.rate = oldRate;
        alert('Failed to update student. Changes have been reverted.');
    }
}

        // Delete a student - OPTIMIZED
async function deleteStudent(studentId) {
    const student = state.students.find(s => s.id === studentId);
    if (!student) return;
    
    const studentEvents = state.events.filter(e => e.studentId === studentId);
    const eventCount = studentEvents.length;
    
    const confirmMsg = `Are you sure you want to delete "${student.name}"?\n\n` +
                      `This will also delete:\n` +
                      `- ${eventCount} scheduled event(s)\n` +
                      `- Payment history\n` +
                      `- Student notes\n\n` +
                      `This action cannot be undone.`;
    
    if (!confirm(confirmMsg)) return;
    
    // Backup for rollback
    const backup = {
        student: {...student},
        events: [...studentEvents],
        paidLessons: state.paidLessons[studentId],
        notes: state.studentNotes[studentId]
    };
    
    try {
        // Remove from state
        state.students = state.students.filter(s => s.id !== studentId);
        state.events = state.events.filter(e => e.studentId !== studentId);
        delete state.paidLessons[studentId];
        delete state.studentNotes[studentId];
        
        // Delete from Firestore
        await deleteStudentFromFirestore(studentId);
        
        // Delete all student events
        await Promise.all(
            studentEvents.map(event => deleteEventFromFirestore(event.id))
        );
        
        // Re-render
        renderStudentsList();
        renderCalendar();
        renderStudentTotals();
        renderPaymentsList();
        
    } catch (error) {
        console.error('Error deleting student:', error);
        
        // Rollback
        state.students.push(backup.student);
        state.events.push(...backup.events);
        state.paidLessons[studentId] = backup.paidLessons;
        state.studentNotes[studentId] = backup.notes;
        
        alert('Failed to delete student. Changes have been reverted.');
        
        // Re-render after rollback
        renderStudentsList();
        renderCalendar();
        renderStudentTotals();
        renderPaymentsList();
    }
}

        // Filter calendar by student
        function filterByStudent(studentId) {
            state.selectedStudent = state.students.find(s => s.id === studentId);
            renderCalendar();
            renderStudentTotals();
        }

        // Save an event - OPTIMIZED
async function saveEvent() {
    const studentId = elements.eventStudentSelect.value;
    const time = elements.eventTimeSelect.value;
    const notes = elements.eventNotesInput.value.trim();
    
    // Validate
    const validation = validateEventData(state.selectedDate, time, studentId);
    if (!validation.valid) {
        alert('Cannot save event:\n' + validation.errors.join('\n'));
        return;
    }
    
    // Disable save button
    elements.saveEventBtn.disabled = true;
    elements.saveEventBtn.textContent = 'Saving...';
    
    try {
        if (state.editingEventId) {
            // Update existing event
            const eventIndex = state.events.findIndex(e => e.id === state.editingEventId);
            if (eventIndex === -1) {
                throw new Error('Event not found');
            }
            
            const oldEvent = {...state.events[eventIndex]};
            
            state.events[eventIndex] = {
                ...state.events[eventIndex],
                time,
                studentId,
                notes
            };
            
            try {
                await saveEventToFirestore(state.events[eventIndex]);
            } catch (error) {
                // Rollback
                state.events[eventIndex] = oldEvent;
                throw error;
            }
            
        } else {
            // Create new event
            const existingEvent = state.events.find(e => 
                e.date === state.selectedDate && e.time === time
            );
            
            if (existingEvent) {
                alert("An event already exists at this time. Please choose a different time or edit the existing event.");
                return;
            }
            
            const newEvent = {
                id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                date: state.selectedDate,
                time,
                studentId,
                notes
            };
            
            state.events.push(newEvent);
            
            try {
                await saveEventToFirestore(newEvent);
            } catch (error) {
                // Rollback
                state.events = state.events.filter(e => e.id !== newEvent.id);
                throw error;
            }
        }
        
        elements.eventModal.classList.add('hidden');
        renderCalendar();
        renderStudentTotals();
        renderPaymentsList();
        
    } catch (error) {
        console.error('Error saving event:', error);
        alert('Failed to save event. Please try again.');
    } finally {
        elements.saveEventBtn.disabled = false;
        elements.saveEventBtn.textContent = 'Save';
    }
}

        // Delete an event - OPTIMIZED
async function deleteEvent() {
    const eventId = elements.deleteEventBtn.dataset.eventId;
    const event = state.events.find(e => e.id === eventId);
    
    if (!event) {
        console.error('Event not found:', eventId);
        elements.eventModal.classList.add('hidden');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this event?')) {
        return;
    }
    
    // Disable delete button
    elements.deleteEventBtn.disabled = true;
    elements.deleteEventBtn.textContent = 'Deleting...';
    
    try {
        // Remove from state
        state.events = state.events.filter(e => e.id !== eventId);
        
        // Delete from Firestore
        await deleteEventFromFirestore(eventId);
        
        elements.eventModal.classList.add('hidden');
        renderCalendar();
        renderStudentTotals();
        renderPaymentsList();
        
    } catch (error) {
        console.error('Error deleting event:', error);
        
        // Rollback
        state.events.push(event);
        alert('Failed to delete event. Please try again.');
    } finally {
        elements.deleteEventBtn.disabled = false;
        elements.deleteEventBtn.textContent = 'Delete';
    }
}

        // Toggle dark/light theme
        async function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            
            if (state.isDarkMode) {
                document.documentElement.classList.add('dark');
                elements.themeToggle.innerHTML = '<i data-feather="sun" class="text-yellow-400 w-4 h-4"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                elements.themeToggle.innerHTML = '<i data-feather="moon" class="text-gray-700 w-4 h-4"></i>';
            }
            
            feather.replace();
            await saveSettingsToFirestore();
        }
    </script>
    </div> <!-- Close #app-content -->
    
    <!-- Logout Button (add to header, will be shown when logged in) -->
</body>
</html>