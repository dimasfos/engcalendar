<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduCalendar Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    
    <style>
        :root {
            --primary: #05cf05;
            --secondary: #dff65c;
        }
        .calendar-day:hover {
            transform: scale(1.05);
        }
        .student-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        #vanta-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }
        .unpaid-event {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
            border: 1px solid #fca5a5;
        }
        .dark .unpaid-event {
            background-color: #7f1d1d !important;
            color: #fca5a5 !important;
            border: 1px solid #991b1b;
        }
        .dark .calendar-day .bg-indigo-100:hover {
            background-color: #4338ca !important;
        }
        .dark .calendar-day .bg-red-100:hover {
            background-color: #991b1d !important;
        }
        .dark #day-view-content .border {
            background-color: #374151;
        }
        .dark #day-view-content .border:hover {
            background-color: #4b5563 !important;
        }
        .dark #day-view-content .border-red-300 {
            background-color: #7f1d1d !important;
            border-color: #991b1b !important;
        }
        .dark #day-view-content .border-red-300:hover {
            background-color: #991b1d !important;
        }
        .dark #day-view-content .bg-red-50 {
            background-color: #7f1d1d !important;
        }
        .current-day {
            background-color: #dbeafe !important;
            border: 2px solid #3b82f6 !important;
        }
        .dark .current-day {
            background-color: #2b3453 !important;
            border: 2px solid #dbeafe !important;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        .dark .login-box {
            background: #1f2937;
        }
        .hidden {
            display: none !important;
        }
        .tab-button.active {
            background-color: #73e546;
            color: white;
        }
        .dark .bg-green-50 {
            background-color: #064e3b !important;
        }
        .dark .text-green-800 {
            color: #6ee7b7 !important;
        }
        .dark .text-green-600 {
            color: #34d399 !important;
        }
        .dark .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        .dark .text-blue-800 {
            color: #93c5fd !important;
        }
        .dark .text-blue-600 {
            color: #60a5fa !important;
        }
        .dark .text-red-600 {
            color: #f87171 !important;
        }
        .dark .bg-red-50 {
            background-color: #7f1d1d !important;
        }
        .dark .text-red-800 {
            color: #fca5a5 !important;
        }
        .dark .bg-indigo-50 {
            background-color: #312e81 !important;
        }
        .dark .text-indigo-600 {
            color: #3c5cff !important;
        }
        .dark .text-indigo-800 {
            color: #98acff !important;
        }
        .dark {
            background-color: #111827;
            color: #fbf9fa;
        }
        .dark .bg-white {
            background-color: #1f2937 !important;
            color: #fbf9fb;
        }
        .dark .bg-gray-50 {
            background-color: #111827 !important;
        }
        .dark .text-gray-800 {
            color: #fbf9fb !important;
        }
        .dark .text-gray-700 {
            color: #d1d5db !important;
        }
        .dark .text-gray-600 {
            color: #9ca3af !important;
        }
        .dark .text-gray-500 {
            color: #6b7280 !important;
        }
        .dark .border {
            border-color: #374151 !important;
        }
        .dark input, .dark select, .dark textarea {
            background-color: #374151 !important;
            color: #f9fafb !important;
            border-color: #4b5563 !important;
        }
        .dark .bg-gray-100 {
            background-color: #374151 !important;
        }
        .dark .bg-gray-200 {
            background-color: #4b5563 !important;
        }
        .dark #vanta-bg {
            opacity: 0.05;
        }
        .dark ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .dark .bg-indigo-100 {
            background-color: #312e81 !important;
        }
        .dark .text-indigo-800 {
            color: #a5b4fc !important;
        }
        .dark #day-view-modal .bg-white,
        .dark #event-modal .bg-white,
        .dark #notes-modal .bg-white,
        .dark #copy-modal .bg-white,
        .dark #announcement-modal .bg-white {
            background-color: #1f2937 !important;
            color: #f9fafb !important;
        }
        .dark .rounded-xl {
            background-color: #1f2937;
        }
        .dark div.bg-white.rounded-xl {
            background-color: #1f2937 !important;
        }
        .dark div.bg-white {
            background-color: #1f2937 !important;
        }
        .dark * {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .dark .balance-card {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        }
        .announcement-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-left: 4px solid #34d399;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .dark .announcement-banner {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border-left-color: #10b981;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <div class="text-center mb-6">
                <i data-feather="calendar" class="text-indigo-600 w-16 h-16 mx-auto mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">EduCalendar Pro</h1>
                <p class="text-gray-600 mt-2">Enter your access code</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Access Code</label>
                    <input type="password" id="login-code" 
                           class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter your code">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="keep-logged-in" class="mr-2">
                    <label for="keep-logged-in" class="text-sm text-gray-700">Keep me logged in</label>
                </div>
                <button id="login-btn" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">
                    Sign In
                </button>
                <div id="login-error" class="text-red-600 text-sm text-center hidden mt-2"></div>
            </div>
        </div>
    </div>

    <!-- Main App Content (initially hidden) -->
    <div id="app-content" class="hidden">
        <div id="vanta-bg"></div>
        
        <!-- Loading indicator -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6">
                <div class="spinner"></div>
                <p class="text-center mt-4 text-gray-700">Loading data...</p>
            </div>
        </div>
        
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-2.5 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i data-feather="calendar" class="text-indigo-600 w-5 h-5"></i>
                    <h1 class="text-xl font-bold text-gray-800">EduCalendar Pro</h1>
                    <span id="sync-status" class="text-xs text-green-600 ml-2">● Synced</span>
                    <span id="user-role-badge" class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded ml-2"></span>
                </div>
                <div class="flex space-x-3">
                    <button id="copy-week-btn" class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition flex items-center admin-only">
                        <i data-feather="copy" class="mr-1.5 w-4 h-4"></i>Copy Week/Month
                    </button>
                    <button id="announcement-btn" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition flex items-center admin-only">
                        <i data-feather="message-square" class="mr-1.5 w-4 h-4"></i>Announcement
                    </button>
                    <button id="theme-toggle" class="p-1.5 rounded-full bg-gray-100 hover:bg-gray-200">
                        <i data-feather="moon" class="text-gray-700 w-4 h-4"></i>
                    </button>
                    <button id="new-event-btn" class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition flex items-center admin-only">
                        <i data-feather="plus" class="mr-1.5 w-4 h-4"></i>New Event
                    </button>
                    <button id="logout-btn" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition flex items-center">
                        <i data-feather="log-out" class="mr-1.5 w-4 h-4"></i>Logout
                    </button>
                </div>
            </div>
        </header>
        <main class="container mx-auto px-4 py-8">
            <!-- Announcement Banner (visible to all when active) -->
            <div id="announcement-banner" class="hidden announcement-banner rounded-xl p-4 mb-6 text-white shadow-lg">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 id="announcement-banner-title" class="font-bold text-lg mb-2"></h3>
                        <p id="announcement-banner-message" class="text-sm opacity-90 whitespace-pre-wrap"></p>
                    </div>
                    <button id="close-announcement-banner" class="ml-4 p-1 hover:bg-white hover:bg-opacity-20 rounded">
                        <i data-feather="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Student Management Section -->
                <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6">
                    <!-- Tabs -->
                    <div class="flex mb-6 border-b">
                        <button id="students-tab" class="tab-button flex-1 py-3 font-semibold transition active">
                            <i data-feather="users" class="mr-2 inline"></i>Students
                        </button>
                        <button id="payments-tab" class="tab-button flex-1 py-3 font-semibold text-gray-600 transition">
                            <i data-feather="credit-card" class="mr-2 inline"></i>Payments
                        </button>
                    </div>
                    
                    <!-- Students Content -->
                    <div id="students-content">
                        <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                            <i data-feather="users" class="mr-2"></i> Student Management
                        </h2>
                        
                        <!-- Add Student Form -->
                        <div class="mb-6 admin-only">
                            <div class="flex space-x-2 mb-4">
                                <input type="text" id="student-name" placeholder="Student Name" 
                                       class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="number" id="student-rate" placeholder="Rate" 
                                       class="w-24 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <button id="add-student" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-800 transition">
                                    <i data-feather="plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Students List -->
                        <div class="space-y-3 max-h-200 overflow-y-auto pr-2" id="students-list">
                            <!-- Student cards will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Payments Content -->
                    <div id="payments-content" class="hidden">
                        <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                            <i data-feather="credit-card" class="mr-2"></i> Payment Tracking
                        </h2>
                        
                        <div class="space-y-4 max-h-200 overflow-y-auto pr-2" id="payments-list">
                            <!-- Payment cards will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Calendar Section -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <!-- Calendar Header -->
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center space-x-3">
                                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i data-feather="calendar" class="mr-2"></i> Schedule
                                </h2>
                                <button id="today-btn" class="px-4 py-2 bg-blue-600 text-white text-base rounded-lg hover:bg-blue-700 transition flex items-center">
                                    <i data-feather="calendar" class="mr-2 w-5 h-5"></i>Today
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <button id="prev-month" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                                    <i data-feather="chevron-left"></i>
                                </button>
                                <h3 id="current-month" class="text-lg font-semibold px-4 py-1">January 2023</h3>
                                <button id="next-month" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                                    <i data-feather="chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Calendar Grid -->
                        <div class="grid grid-cols-7 gap-2 mb-4">
                            <div class="text-center font-medium text-gray-500 py-2">Sun</div>
                            <div class="text-center font-medium text-gray-500 py-2">Mon</div>
                            <div class="text-center font-medium text-gray-500 py-2">Tue</div>
                            <div class="text-center font-medium text-gray-500 py-2">Wed</div>
                            <div class="text-center font-medium text-gray-500 py-2">Thu</div>
                            <div class="text-center font-medium text-gray-500 py-2">Fri</div>
                            <div class="text-center font-medium text-gray-500 py-2">Sat</div>
                        </div>
                        
                        <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                            <!-- Calendar days will be populated here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div class="mt-6 bg-white rounded-xl shadow-md p-6 admin-only">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                            <i data-feather="dollar-sign" class="mr-2"></i> Financial Summary
                        </h2>
                        
                        <div id="student-totals" class="space-y-3 mb-4 max-h-48 overflow-y-auto">
                            <!-- Student totals will be added here dynamically -->
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-gray-700">Month Total:</span>
                                <span id="month-total" class="text-xl font-bold text-indigo-600">₴0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Student Notes Modal -->
        <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold" id="notes-modal-title">Notes for [Student]</h3>
                    <button id="close-notes-modal" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <textarea id="student-notes-textarea" rows="10" 
                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                              placeholder="Enter notes for this student..."></textarea>
                </div>
                <div class="flex justify-end">
                    <button id="save-student-notes" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Save Notes
                    </button>
                </div>
            </div>
        </div>

        <!-- Day View Modal -->
        <div id="day-view-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold" id="day-view-title">Events for [Date]</h3>
                    <button id="close-day-view" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div id="day-view-content" class="space-y-3 mb-4">
                    <!-- Events will be listed here -->
                </div>
                <div class="flex justify-end pt-2 border-t admin-only">
                    <button id="add-event-from-day-view" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        <i data-feather="plus" class="mr-2"></i>Add Event
                    </button>
                </div>
            </div>
        </div>

        <!-- Copy Week/Month Modal -->
        <div id="copy-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Copy Events</h3>
                    <button id="close-copy-modal" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Copy Type</label>
                        <select id="copy-type" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="week">Week</option>
                            <option value="month">Month</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                        <input type="date" id="copy-from-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                        <input type="date" id="copy-to-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button id="cancel-copy" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg transition">
                            Cancel
                        </button>
                        <button id="execute-copy" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            Copy Events
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event Modal -->
        <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Schedule Event</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="text" id="event-date" readonly 
                               class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                        <select id="event-time" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <!-- Time options will be added dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Student</label>
                        <select id="event-student" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be added dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea id="event-notes" rows="3" 
                                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="admin-only">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="event-repeat-weekly" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="text-sm font-medium text-gray-700">
                                <i data-feather="repeat" class="w-4 h-4 inline mr-1"></i>
                                Repeat every week until end of month
                            </span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button id="delete-event" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition hidden">
                            Delete
                        </button>
                        <button id="save-event" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Announcement Modal (Admin Only) -->
        <div id="announcement-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Post Announcement</h3>
                    <button id="close-announcement-modal" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Announcement Title</label>
                        <input type="text" id="announcement-title" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Enter title...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                        <textarea id="announcement-message" rows="6" 
                                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                  placeholder="Enter your announcement message..."></textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="announcement-active" class="mr-2" checked>
                        <label for="announcement-active" class="text-sm text-gray-700">Show to students</label>
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button id="delete-announcement" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                            Clear Announcement
                        </button>
                        <button id="save-announcement" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Save & Publish
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <script>
        // Initialize Vanta.js background
        VANTA.GLOBE({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: "#6366f1",
            backgroundColor: "#f9fafb"
        });

        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            API_BASE_URL: '/api',
            TIME_SLOTS: { start: 8, end: 20 },
            STORAGE_KEY: 'eduCalendarAuth',
            NOTIFICATION_DURATION: 3000
        };

        // ============================================
        // API SERVICE
        // ============================================
        const API = {
            // Get auth token from localStorage
            getAuthToken() {
                const auth = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (auth) {
                    try {
                        const authData = JSON.parse(auth);
                        return authData.code;
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            },

            // Make authenticated API request
            async request(endpoint, options = {}) {
                const token = this.getAuthToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                };

                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`, {
                        ...options,
                        headers
                    });

                    if (response.status === 401) {
                        // Unauthorized - clear auth and redirect to login
                        localStorage.removeItem(CONFIG.STORAGE_KEY);
                        window.location.reload();
                        throw new Error('Authentication failed');
                    }

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Request failed');
                    }

                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            },

            // Authentication
            async login(code, keepLoggedIn) {
                const data = await this.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ code })
                });

                if (data.success && keepLoggedIn) {
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data.user));
                }

                return data;
            },

            async validateToken() {
                return await this.request('/auth/validate');
            },

            // Students
            async getStudents() {
                return await this.request('/students');
            },

            async createStudent(name, rate) {
                return await this.request('/students', {
                    method: 'POST',
                    body: JSON.stringify({ name, rate })
                });
            },

            async updateStudent(id, data) {
                return await this.request(`/students/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },

            async deleteStudent(id) {
                return await this.request(`/students/${id}`, {
                    method: 'DELETE'
                });
            },

            async generateAccessCode(id) {
                return await this.request(`/students/${id}/generate-code`, {
                    method: 'POST'
                });
            },

            // Events
            async getEvents() {
                return await this.request('/events');
            },

            async createEvent(eventData) {
                return await this.request('/events', {
                    method: 'POST',
                    body: JSON.stringify(eventData)
                });
            },

            async updateEvent(id, eventData) {
                return await this.request(`/events/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(eventData)
                });
            },

            async deleteEvent(id) {
                return await this.request(`/events/${id}`, {
                    method: 'DELETE'
                });
            },

            async copyEvents(copyType, fromDate, toDate) {
                return await this.request('/events/copy', {
                    method: 'POST',
                    body: JSON.stringify({ copyType, fromDate, toDate })
                });
            },

            // Payments
            async getPayments() {
                return await this.request('/payments');
            },

            async updatePayment(studentId, count) {
                return await this.request(`/payments/${studentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ count })
                });
            },

            async addPaidLessons(studentId, lessons) {
                return await this.request(`/payments/${studentId}/add`, {
                    method: 'POST',
                    body: JSON.stringify({ lessons })
                });
            },

            // Notes
            async getNotes() {
                return await this.request('/notes');
            },

            async getStudentNotes(studentId) {
                return await this.request(`/notes/${studentId}`);
            },

            async updateNotes(studentId, notes) {
                return await this.request(`/notes/${studentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ notes })
                });
            },

            // Announcements
            async getAnnouncement() {
                return await this.request('/announcements/current');
            },

            async saveAnnouncement(title, message, active) {
                return await this.request('/announcements', {
                    method: 'POST',
                    body: JSON.stringify({ title, message, active })
                });
            },

            async deleteAnnouncement() {
                return await this.request('/announcements/current', {
                    method: 'DELETE'
                });
            },

            // Settings
            async getSettings() {
                return await this.request('/settings');
            },

            async updateSettings(isDarkMode) {
                return await this.request('/settings', {
                    method: 'PUT',
                    body: JSON.stringify({ isDarkMode })
                });
            }
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let state = {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDate: null,
            selectedStudent: null,
            editingEventId: null,
            students: [],
            events: [],
            paidLessons: {},
            studentNotes: {},
            isDarkMode: false,
            isAuthenticated: false,
            currentUser: null,
            announcement: {
                title: '',
                message: '',
                active: false,
                dismissed: false
            }
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthDisplay: document.getElementById('current-month'),
            studentsList: document.getElementById('students-list'),
            studentTotals: document.getElementById('student-totals'),
            monthTotal: document.getElementById('month-total'),
            studentNameInput: document.getElementById('student-name'),
            studentRateInput: document.getElementById('student-rate'),
            addStudentBtn: document.getElementById('add-student'),
            prevMonthBtn: document.getElementById('prev-month'),
            nextMonthBtn: document.getElementById('next-month'),
            eventModal: document.getElementById('event-modal'),
            closeModalBtn: document.getElementById('close-modal'),
            eventDateInput: document.getElementById('event-date'),
            eventTimeSelect: document.getElementById('event-time'),
            eventStudentSelect: document.getElementById('event-student'),
            eventNotesInput: document.getElementById('event-notes'),
            saveEventBtn: document.getElementById('save-event'),
            deleteEventBtn: document.getElementById('delete-event'),
            themeToggle: document.getElementById('theme-toggle'),
            newEventBtn: document.getElementById('new-event-btn'),
            dayViewModal: document.getElementById('day-view-modal'),
            closeDayViewBtn: document.getElementById('close-day-view'),
            dayViewTitle: document.getElementById('day-view-title'),
            dayViewContent: document.getElementById('day-view-content'),
            addEventFromDayViewBtn: document.getElementById('add-event-from-day-view'),
            studentsTab: document.getElementById('students-tab'),
            paymentsTab: document.getElementById('payments-tab'),
            studentsContent: document.getElementById('students-content'),
            paymentsContent: document.getElementById('payments-content'),
            paymentsList: document.getElementById('payments-list'),
            copyWeekBtn: document.getElementById('copy-week-btn'),
            copyModal: document.getElementById('copy-modal'),
            closeCopyModal: document.getElementById('close-copy-modal'),
            copyType: document.getElementById('copy-type'),
            copyFromDate: document.getElementById('copy-from-date'),
            copyToDate: document.getElementById('copy-to-date'),
            executeCopy: document.getElementById('execute-copy'),
            cancelCopy: document.getElementById('cancel-copy'),
            notesModal: document.getElementById('notes-modal'),
            closeNotesModal: document.getElementById('close-notes-modal'),
            notesModalTitle: document.getElementById('notes-modal-title'),
            studentNotesTextarea: document.getElementById('student-notes-textarea'),
            saveStudentNotes: document.getElementById('save-student-notes'),
            loadingOverlay: document.getElementById('loading-overlay'),
            syncStatus: document.getElementById('sync-status'),
            loginPage: document.getElementById('login-page'),
            appContent: document.getElementById('app-content'),
            loginCode: document.getElementById('login-code'),
            loginBtn: document.getElementById('login-btn'),
            loginError: document.getElementById('login-error'),
            keepLoggedIn: document.getElementById('keep-logged-in'),
            logoutBtn: document.getElementById('logout-btn'),
            userRoleBadge: document.getElementById('user-role-badge'),
            announcementBtn: document.getElementById('announcement-btn'),
            announcementModal: document.getElementById('announcement-modal'),
            closeAnnouncementModal: document.getElementById('close-announcement-modal'),
            announcementTitle: document.getElementById('announcement-title'),
            announcementMessage: document.getElementById('announcement-message'),
            announcementActive: document.getElementById('announcement-active'),
            saveAnnouncement: document.getElementById('save-announcement'),
            deleteAnnouncement: document.getElementById('delete-announcement'),
            announcementBanner: document.getElementById('announcement-banner'),
            announcementBannerTitle: document.getElementById('announcement-banner-title'),
            announcementBannerMessage: document.getElementById('announcement-banner-message'),
            closeAnnouncementBanner: document.getElementById('close-announcement-banner'),
            todayBtn: document.getElementById('today-btn'),
            eventRepeatWeekly: document.getElementById('event-repeat-weekly')
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showLoading() {
            elements.loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
        }

        function updateSyncStatus(synced) {
            if (synced) {
                elements.syncStatus.textContent = '● Synced';
                elements.syncStatus.className = 'text-xs text-green-600 ml-2';
            } else {
                elements.syncStatus.textContent = '● Syncing...';
                elements.syncStatus.className = 'text-xs text-yellow-600 ml-2';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            } text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, CONFIG.NOTIFICATION_DURATION);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        function formatDateString(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function isAdmin() {
            return state.currentUser?.role === 'admin';
        }

        function canViewStudent(studentId) {
            if (!state.currentUser) return false;
            if (isAdmin()) return true;
            return state.currentUser.studentId === studentId;
        }
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function checkExistingAuth() {
            const savedAuth = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (savedAuth) {
                try {
                    const authData = JSON.parse(savedAuth);
                    state.currentUser = authData;
                    state.isAuthenticated = true;
                    return true;
                } catch (e) {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    return false;
                }
            }
            return false;
        }

        async function handleLogin() {
            const code = elements.loginCode.value.trim();
            const keepLoggedIn = elements.keepLoggedIn.checked;
            
            if (!code) {
                showLoginError('Please enter an access code');
                return;
            }
            
            elements.loginBtn.disabled = true;
            elements.loginBtn.textContent = 'Signing in...';
            
            try {
                const response = await API.login(code, keepLoggedIn);
                
                if (response.success) {
                    state.isAuthenticated = true;
                    state.currentUser = response.user;
                    
                    elements.loginPage.classList.add('hidden');
                    elements.appContent.classList.remove('hidden');
                    
                    updateUIForRole();
                    await init();
                }
            } catch (error) {
                showLoginError(error.message || 'Invalid access code. Please try again.');
                elements.loginCode.value = '';
            } finally {
                elements.loginBtn.disabled = false;
                elements.loginBtn.textContent = 'Sign In';
            }
        }

        function showLoginError(message) {
            elements.loginError.textContent = message;
            elements.loginError.classList.remove('hidden');
            setTimeout(() => {
                elements.loginError.classList.add('hidden');
            }, CONFIG.NOTIFICATION_DURATION);
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                state.isAuthenticated = false;
                state.currentUser = null;
                localStorage.removeItem(CONFIG.STORAGE_KEY);
                
                elements.appContent.classList.add('hidden');
                elements.loginPage.classList.remove('hidden');
                elements.loginCode.value = '';
                elements.keepLoggedIn.checked = false;
            }
        }

        function updateUIForRole() {
            const adminRole = isAdmin();
            
            elements.userRoleBadge.textContent = adminRole ? 'Admin' : 'Student';
            elements.userRoleBadge.className = adminRole 
                ? 'text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded ml-2'
                : 'text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2';
            
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = adminRole ? '' : 'none';
            });
            
            if (!adminRole) {
                const studentManagementSection = document.querySelector('.lg\\:col-span-1');
                if (studentManagementSection) {
                    studentManagementSection.style.display = 'none';
                }
                const calendarSection = document.querySelector('.lg\\:col-span-2');
                if (calendarSection) {
                    calendarSection.className = 'lg:col-span-3';
                }
            }
        }

        // ============================================
        // DATA LOADING FUNCTIONS
        // ============================================
        async function loadAllData() {
            try {
                showLoading();
                updateSyncStatus(false);
                
                const [studentsData, eventsData, paymentsData, notesData, settingsData, announcementData] = await Promise.all([
                    API.getStudents(),
                    API.getEvents(),
                    API.getPayments(),
                    API.getNotes(),
                    API.getSettings(),
                    API.getAnnouncement()
                ]);
                
                state.students = studentsData.students || [];
                state.events = eventsData.events || [];
                state.paidLessons = paymentsData.payments || {};
                state.studentNotes = notesData.notes || {};
                
                if (settingsData.isDarkMode) {
                    state.isDarkMode = true;
                    document.documentElement.classList.add('dark');
                    elements.themeToggle.innerHTML = '<i data-feather="sun" class="text-yellow-400 w-4 h-4"></i>';
                }
                
                state.announcement = {
                    title: announcementData.title || '',
                    message: announcementData.message || '',
                    active: announcementData.active || false,
                    dismissed: false
                };
                
                updateSyncStatus(true);
                hideLoading();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load data. Please refresh the page.', 'error');
                hideLoading();
                updateSyncStatus(true);
            }
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function isLessonPaid(studentId, eventId) {
            const paidCount = state.paidLessons[studentId] || 0;
            const studentEvents = state.events
                .filter(e => e.studentId === studentId)
                .sort((a, b) => {
                    const dateCompare = a.date.localeCompare(b.date);
                    return dateCompare !== 0 ? dateCompare : a.time.localeCompare(b.time);
                });
            
            const eventIndex = studentEvents.findIndex(e => e.id === eventId);
            return eventIndex !== -1 && eventIndex < paidCount;
        }

        function renderCalendar() {
            elements.calendarGrid.innerHTML = '';
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];
            elements.currentMonthDisplay.textContent = `${monthNames[state.currentMonth]} ${state.currentYear}`;
            
            const firstDay = new Date(state.currentYear, state.currentMonth, 1).getDay();
            const daysInMonth = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-24 bg-gray-50 rounded-lg';
                fragment.appendChild(emptyDay);
            }
            
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDateString(state.currentYear, state.currentMonth + 1, day);
                const isToday = day === today.getDate() && 
                                state.currentMonth === today.getMonth() && 
                                state.currentYear === today.getFullYear();
                
                let dayEvents = state.events.filter(event => event.date === dateStr);
                if (!isAdmin() && state.currentUser?.studentId) {
                    dayEvents = dayEvents.filter(event => event.studentId === state.currentUser.studentId);
                }
                dayEvents.sort((a, b) => a.time.localeCompare(b.time));
                
                const dayElement = document.createElement('div');
                dayElement.className = `h-24 border rounded-lg calendar-day overflow-hidden cursor-pointer transition${isToday ? ' current-day' : ''}`;
                
                const eventsHtml = dayEvents.map(event => {
                    const student = state.students.find(s => s.id === event.studentId);
                    const isPaid = isLessonPaid(event.studentId, event.id);
                    const studentName = isAdmin() && student ? ` - ${escapeHtml(student.name)}` : '';
                    
                    return `
                        <div class="text-xs p-1 ${isPaid ? 'bg-indigo-100 text-indigo-800' : 'bg-red-100 text-red-800 unpaid-event'} rounded truncate hover:bg-indigo-200 cursor-pointer" 
                             data-event-id="${event.id}">
                            ${event.time}${studentName}
                        </div>
                    `;
                }).join('');
                
                dayElement.innerHTML = `
                    <div class="p-2 h-full flex flex-col">
                        <div class="text-right font-medium">${day}</div>
                        <div class="flex-1 overflow-y-auto mt-1 space-y-1">
                            ${eventsHtml}
                        </div>
                    </div>
                `;
                
                dayElement.addEventListener('click', (e) => {
                    const eventElement = e.target.closest('[data-event-id]');
                    if (eventElement) {
                        e.stopPropagation();
                        const eventId = eventElement.dataset.eventId;
                        const event = state.events.find(ev => ev.id === eventId);
                        if (event) {
                            if (isAdmin()) {
                                openEditEventModal(event);
                            } else {
                                openEventDetailView(event);
                            }
                        }
                    } else {
                        if (isAdmin()) {
                            openDayView(day, state.currentMonth + 1, state.currentYear);
                        }
                    }
                });
                
                fragment.appendChild(dayElement);
            }
            
            elements.calendarGrid.appendChild(fragment);
            feather.replace();
        }

        function renderStudentsList() {
            elements.studentsList.innerHTML = '';
            
            if (state.students.length === 0) {
                elements.studentsList.innerHTML = '<p class="text-gray-500 text-center py-8">No students yet</p>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            state.students.forEach(student => {
                const studentElement = document.createElement('div');
                studentElement.className = 'bg-white border rounded-lg p-3 student-card transition cursor-pointer';
                studentElement.dataset.studentId = student.id;
                
                studentElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <h3 class="font-medium">${escapeHtml(student.name)}</h3>
                            <p class="text-sm text-gray-500">₴${student.rate}/session</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="p-1 text-green-600 hover:text-green-800 notes-student" data-id="${student.id}" title="Student Notes">
                                <i data-feather="file-text" class="w-4 h-4"></i>
                            </button>
                            <button class="p-1 text-indigo-600 hover:text-indigo-800 edit-student" data-id="${student.id}" title="Edit Student">
                                <i data-feather="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="p-1 text-red-600 hover:text-red-800 delete-student" data-id="${student.id}" title="Delete Student">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 pt-2 border-t">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">Access Code:</span>
                            <div class="flex items-center space-x-1">
                                <code class="text-xs bg-gray-100 px-2 py-1 rounded" id="code-${student.id}">
                                    ${student.accessCode || 'Not set'}
                                </code>
                                <button class="p-1 text-blue-600 hover:text-blue-800 generate-code" data-id="${student.id}" title="Generate Code">
                                    <i data-feather="refresh-cw" class="w-3 h-3"></i>
                                </button>
                                ${student.accessCode ? `
                                <button class="p-1 text-gray-600 hover:text-gray-800 copy-code" data-id="${student.id}" title="Copy Code">
                                    <i data-feather="copy" class="w-3 h-3"></i>
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(studentElement);
            });
            
            elements.studentsList.appendChild(fragment);
            feather.replace();
            attachStudentListeners();
        }

        function attachStudentListeners() {
            document.querySelectorAll('.notes-student').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openStudentNotesModal(btn.dataset.id);
                });
            });
            
            document.querySelectorAll('.edit-student').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const studentId = btn.dataset.id;
                    const student = state.students.find(s => s.id === studentId);
                    if (!student) return;
                    
                    const newName = prompt("Edit student name:", student.name);
                    if (newName === null) return;
                    
                    const newRateStr = prompt("Edit student rate:", student.rate);
                    if (newRateStr === null) return;
                    
                    const newRate = parseFloat(newRateStr);
                    
                    if (!newName.trim() || isNaN(newRate) || newRate < 0) {
                        alert('Invalid data. Please try again.');
                        return;
                    }
                    
                    try {
                        updateSyncStatus(false);
                        await API.updateStudent(studentId, { name: newName.trim(), rate: newRate });
                        student.name = newName.trim();
                        student.rate = newRate;
                        renderStudentsList();
                        renderStudentTotals();
                        renderPaymentsList();
                        updateSyncStatus(true);
                        showNotification('Student updated successfully!', 'success');
                    } catch (error) {
                        showNotification('Failed to update student', 'error');
                        updateSyncStatus(true);
                    }
                });
            });
            
            document.querySelectorAll('.delete-student').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const studentId = btn.dataset.id;
                    const student = state.students.find(s => s.id === studentId);
                    if (!student) return;
                    
                    const studentEvents = state.events.filter(e => e.studentId === studentId);
                    const confirmMsg = `Are you sure you want to delete "${student.name}"?\n\nThis will also delete ${studentEvents.length} scheduled event(s).\n\nThis action cannot be undone.`;
                    
                    if (!confirm(confirmMsg)) return;
                    
                    try {
                        updateSyncStatus(false);
                        await API.deleteStudent(studentId);
                        state.students = state.students.filter(s => s.id !== studentId);
                        state.events = state.events.filter(e => e.studentId !== studentId);
                        delete state.paidLessons[studentId];
                        delete state.studentNotes[studentId];
                        renderStudentsList();
                        renderCalendar();
                        renderStudentTotals();
                        renderPaymentsList();
                        updateSyncStatus(true);
                        showNotification('Student deleted successfully', 'success');
                    } catch (error) {
                        showNotification('Failed to delete student', 'error');
                        updateSyncStatus(true);
                    }
                });
            });
            
            document.querySelectorAll('.generate-code').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const studentId = btn.dataset.id;
                    const student = state.students.find(s => s.id === studentId);
                    if (!student) return;
                    
                    try {
                        updateSyncStatus(false);
                        const response = await API.generateAccessCode(studentId);
                        student.accessCode = response.accessCode;
                        renderStudentsList();
                        updateSyncStatus(true);
                        showNotification('Access code generated!', 'success');
                    } catch (error) {
                        showNotification('Failed to generate code', 'error');
                        updateSyncStatus(true);
                    }
                });
            });
            
            document.querySelectorAll('.copy-code').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const studentId = btn.dataset.id;
                    const student = state.students.find(s => s.id === studentId);
                    if (!student || !student.accessCode) return;
                    
                    try {
                        await navigator.clipboard.writeText(student.accessCode);
                        const codeElement = document.getElementById(`code-${studentId}`);
                        if (codeElement) {
                            const originalText = codeElement.textContent;
                            codeElement.textContent = 'Copied!';
                            codeElement.classList.add('text-green-600');
                            setTimeout(() => {
                                codeElement.textContent = originalText;
                                codeElement.classList.remove('text-green-600');
                            }, 1500);
                        }
                    } catch (error) {
                        showNotification('Failed to copy code', 'error');
                    }
                });
            });
        }

        function renderPaymentsList() {
            elements.paymentsList.innerHTML = '';
            
            if (state.currentUser && state.currentUser.role === 'student' && state.currentUser.studentId) {
                const student = state.students.find(s => s.id === state.currentUser.studentId);
                if (student) {
                    const paidLessons = state.paidLessons[student.id] || 0;
                    const scheduledLessons = state.events.filter(e => e.studentId === student.id).length;
                    const remainingLessons = paidLessons - scheduledLessons;
                    
                    const balanceCard = document.createElement('div');
                    balanceCard.className = 'balance-card mb-6';
                    balanceCard.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                                    <i data-feather="book-open" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold">${remainingLessons}</h3>
                                    <p class="text-sm opacity-90">Paid Lessons Left</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 pt-4 border-t border-white border-opacity-20">
                            <div class="text-center">
                                <div class="text-2xl font-bold">${paidLessons}</div>
                                <div class="text-xs opacity-75">Total Paid</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${scheduledLessons}</div>
                                <div class="text-xs opacity-75">Scheduled</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold ${remainingLessons < 0 ? 'text-red-300' : 'text-green-300'}">
                                    ${remainingLessons < 0 ? '⚠️' : '✓'}
                                </div>
                                <div class="text-xs opacity-75">${remainingLessons < 0 ? 'Overdue' : 'Available'}</div>
                            </div>
                        </div>
                        ${remainingLessons <= 0 ? `
                        <div class="mt-4 p-3 bg-red-500 bg-opacity-30 rounded-lg text-sm">
                            <strong>⚠️ ${remainingLessons < 0 ? 'You have ' + Math.abs(remainingLessons) + ' unpaid lesson(s)' : 'No lesson credits remaining'}</strong><br>
                            Please contact your teacher to add more lessons.
                        </div>
                        ` : remainingLessons <= 2 ? `
                        <div class="mt-4 p-3 bg-yellow-500 bg-opacity-30 rounded-lg text-sm">
                            <strong>⚠️ Low balance:</strong> Only ${remainingLessons} lesson(s) remaining. Consider adding more soon.
                        </div>
                        ` : ''}
                    `;
                    elements.paymentsList.appendChild(balanceCard);
                    feather.replace();
                }
            }
            
            const studentsToShow = state.currentUser && state.currentUser.role === 'student' 
                ? state.students.filter(s => s.id === state.currentUser.studentId)
                : state.students;
            
            if (studentsToShow.length === 0) {
                elements.paymentsList.innerHTML += '<p class="text-gray-500 text-center py-8">No students added yet</p>';
                return;
            }
            
            const adminRole = isAdmin();
            const fragment = document.createDocumentFragment();
            
            studentsToShow.forEach(student => {
                const paidLessons = state.paidLessons[student.id] || 0;
                const scheduledLessons = state.events.filter(e => e.studentId === student.id).length;
                const remainingLessons = paidLessons - scheduledLessons;
                
                const paymentCard = document.createElement('div');
                paymentCard.className = 'border rounded-lg p-4';
                paymentCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-lg">${escapeHtml(student.name)}</h3>
                            <p class="text-sm text-gray-500">Rate: ₴${student.rate}/lesson</p>
                            ${remainingLessons <= 0 ? '<p class="text-xs text-red-600 font-semibold mt-1">⚠️ No paid lessons remaining</p>' : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 mb-1">Paid Lessons Left</div>
                            <div class="text-2xl font-bold ${remainingLessons < 0 ? 'text-red-600' : remainingLessons === 0 ? 'text-orange-600' : 'text-green-600'}">
                                ${remainingLessons}
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                        <div class="bg-green-50 p-2 rounded">
                            <div class="text-green-800 font-medium">Paid</div>
                            <div class="text-green-600 text-lg">${paidLessons}</div>
                        </div>
                        <div class="bg-blue-50 p-2 rounded">
                            <div class="text-blue-800 font-medium">Scheduled</div>
                            <div class="text-blue-600 text-lg">${scheduledLessons}</div>
                        </div>
                    </div>
                    ${adminRole ? `
                    <div class="flex space-x-2">
                        <input type="number" 
                               id="add-lessons-${student.id}" 
                               placeholder="Lessons" 
                               min="1"
                               class="flex-1 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                        <button class="add-paid-lessons px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm"
                                data-student-id="${student.id}">
                            <i data-feather="plus" class="w-4 h-4"></i>
                        </button>
                    </div>` : ''}
                `;
                fragment.appendChild(paymentCard);
            });
            
            elements.paymentsList.appendChild(fragment);
            feather.replace();
            
            if (adminRole) {
                document.querySelectorAll('.add-paid-lessons').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const studentId = btn.dataset.studentId;
                        const input = document.getElementById(`add-lessons-${studentId}`);
                        const lessons = parseInt(input.value);
                        
                        if (lessons && lessons > 0) {
                            try {
                                updateSyncStatus(false);
                                await API.addPaidLessons(studentId, lessons);
                                state.paidLessons[studentId] = (state.paidLessons[studentId] || 0) + lessons;
                                input.value = '';
                                renderPaymentsList();
                                renderCalendar();
                                updateSyncStatus(true);
                                showNotification(`Added ${lessons} lesson(s)`, 'success');
                            } catch (error) {
                                showNotification('Failed to add lessons', 'error');
                                updateSyncStatus(true);
                            }
                        }
                    });
                });
            }
        }

        function renderStudentTotals() {
            if (state.currentUser && state.currentUser.role === 'student') {
                const financialSummary = document.querySelector('.mt-6.bg-white.rounded-xl.shadow-md.p-6');
                if (financialSummary && financialSummary.querySelector('#student-totals')) {
                    financialSummary.style.display = 'none';
                }
                return;
            }
            
            elements.studentTotals.innerHTML = '';
            
            let monthTotal = 0;
            const monthStr = `${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}`;
            
            state.students.forEach(student => {
                const studentEvents = state.events.filter(event => 
                    event.studentId === student.id && event.date.startsWith(monthStr)
                );
                
                const paidLessonsCount = studentEvents.filter(event => 
                    isLessonPaid(student.id, event.id)
                ).length;
                
                const studentTotal = paidLessonsCount * student.rate;
                monthTotal += studentTotal;
                
                const totalElement = document.createElement('div');
                totalElement.className = `flex justify-between items-center p-2 rounded-lg ${state.selectedStudent && state.selectedStudent.id === student.id ? 'bg-indigo-50' : ''}`;
                totalElement.innerHTML = `
                    <span>${escapeHtml(student.name)}</span>
                    <span class="font-medium">₴${studentTotal.toFixed(2)}</span>
                `;
                
                totalElement.addEventListener('click', () => {
                    state.selectedStudent = student;
                    renderStudentTotals();
                });
                
                elements.studentTotals.appendChild(totalElement);
            });
            
            elements.monthTotal.textContent = `₴${monthTotal.toFixed(2)}`;
        }

        // Continue in next message due to length...
        
        async function addStudent() {
            const name = elements.studentNameInput.value.trim();
            const rate = parseFloat(elements.studentRateInput.value);
            
            if (!name || isNaN(rate) || rate < 0) {
                alert('Please enter valid student name and rate');
                return;
            }
            
            elements.addStudentBtn.disabled = true;
            
            try {
                updateSyncStatus(false);
                const response = await API.createStudent(name, rate);
                state.students.push(response.student);
                state.paidLessons[response.student.id] = 0;
                state.studentNotes[response.student.id] = '';
                
                elements.studentNameInput.value = '';
                elements.studentRateInput.value = '';
                
                renderStudentsList();
                renderStudentTotals();
                renderPaymentsList();
                updateSyncStatus(true);
                showNotification('Student added successfully!', 'success');
            } catch (error) {
                showNotification('Failed to add student', 'error');
                updateSyncStatus(true);
            } finally {
                elements.addStudentBtn.disabled = false;
            }
        }

        async function openStudentNotesModal(studentId) {
            const student = state.students.find(s => s.id === studentId);
            if (!student) return;
            
            state.selectedStudent = student;
            elements.notesModalTitle.textContent = `Notes for ${student.name}`;
            elements.studentNotesTextarea.value = state.studentNotes[studentId] || '';
            elements.notesModal.classList.remove('hidden');
            feather.replace();
        }

        async function saveStudentNotes() {
            if (!state.selectedStudent) return;
            
            const notes = elements.studentNotesTextarea.value;
            
            try {
                updateSyncStatus(false);
                await API.updateNotes(state.selectedStudent.id, notes);
                state.studentNotes[state.selectedStudent.id] = notes;
                elements.notesModal.classList.add('hidden');
                updateSyncStatus(true);
                showNotification('Notes saved successfully!', 'success');
            } catch (error) {
                showNotification('Failed to save notes', 'error');
                updateSyncStatus(true);
            }
        }

        function openDayView(day, month, year) {
            const dateStr = formatDateString(year, month, day);
            state.selectedDate = dateStr;
            
            const dayEvents = state.events.filter(event => event.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
            
            const date = new Date(dateStr);
            elements.dayViewTitle.textContent = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            elements.dayViewContent.innerHTML = '';
            
            if (dayEvents.length === 0) {
                elements.dayViewContent.innerHTML = '<p class="text-gray-500 text-center py-8">No events scheduled for this day</p>';
            } else {
                dayEvents.forEach(event => {
                    const student = state.students.find(s => s.id === event.studentId);
                    const isPaid = isLessonPaid(event.studentId, event.id);
                    const eventCard = document.createElement('div');
                    eventCard.className = `border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition ${!isPaid ? 'border-red-300 bg-red-50' : ''}`;
                    eventCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-semibold ${isPaid ? 'text-indigo-600' : 'text-red-600'}">${event.time}</span>
                                    <span class="text-gray-400">•</span>
                                    <span class="font-medium">${student ? escapeHtml(student.name) : 'Unknown'}</span>
                                    ${!isPaid ? '<span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded">UNPAID</span>' : ''}
                                </div>
                                ${event.notes ? `<p class="text-sm text-gray-600">${escapeHtml(event.notes)}</p>` : ''}
                                ${!isPaid ? '<p class="text-xs text-red-600 font-semibold mt-1">⚠️ This lesson is not paid</p>' : ''}
                                ${student ? `<p class="text-xs text-gray-500 mt-1">Rate: ₴${student.rate}</p>` : ''}
                            </div>
                            <div class="flex space-x-1">
                                <button class="p-2 text-indigo-600 hover:bg-indigo-50 rounded edit-day-event" data-event-id="${event.id}">
                                    <i data-feather="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button class="p-2 text-red-600 hover:bg-red-50 rounded delete-day-event" data-event-id="${event.id}">
                                    <i data-feather="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    elements.dayViewContent.appendChild(eventCard);
                });
                
                feather.replace();
                
                document.querySelectorAll('.edit-day-event').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const eventId = btn.dataset.eventId;
                        const event = state.events.find(ev => ev.id === eventId);
                        if (event) {
                            elements.dayViewModal.classList.add('hidden');
                            openEditEventModal(event);
                        }
                    });
                });
                
                document.querySelectorAll('.delete-day-event').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const eventId = btn.dataset.eventId;
                        if (confirm('Are you sure you want to delete this event?')) {
                            try {
                                updateSyncStatus(false);
                                await API.deleteEvent(eventId);
                                state.events = state.events.filter(e => e.id !== eventId);
                                renderCalendar();
                                renderStudentTotals();
                                renderPaymentsList();
                                updateSyncStatus(true);
                                showNotification('Event deleted successfully', 'success');
                                openDayView(day, month, year);
                            } catch (error) {
                                showNotification('Failed to delete event', 'error');
                                updateSyncStatus(true);
                            }
                        }
                    });
                });
            }
            
            elements.dayViewModal.classList.remove('hidden');
            feather.replace();
        }

        function openTodayView() {
            const today = new Date();
            openDayView(today.getDate(), today.getMonth() + 1, today.getFullYear());
        }

        function openEventDetailView(event) {
            const student = state.students.find(s => s.id === event.studentId);
            const isPaid = isLessonPaid(event.studentId, event.id);
            
            const date = new Date(event.date);
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            alert(`Lesson Details\n\nDate: ${dateStr}\nTime: ${event.time}\nStatus: ${isPaid ? 'Paid' : 'Unpaid'}\n${event.notes ? 'Notes: ' + event.notes : ''}`);
        }

        function openEventModal(day, month, year) {
            const dateStr = formatDateString(year, month, day);
            state.selectedDate = dateStr;
            state.editingEventId = null;
            
            elements.eventTimeSelect.innerHTML = '';
            for (let hour = CONFIG.TIME_SLOTS.start; hour <= CONFIG.TIME_SLOTS.end; hour++) {
                const time = `${String(hour).padStart(2, '0')}:00`;
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                elements.eventTimeSelect.appendChild(option);
            }
            
            elements.eventStudentSelect.innerHTML = '';
            state.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                elements.eventStudentSelect.appendChild(option);
            });
            
            elements.eventTimeSelect.value = '08:00';
            elements.eventStudentSelect.value = '';
            elements.eventNotesInput.value = '';
            elements.eventRepeatWeekly.checked = false;
            elements.eventRepeatWeekly.parentElement.style.display = '';
            elements.deleteEventBtn.classList.add('hidden');
            
            elements.eventDateInput.value = new Date(dateStr).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.eventModal.classList.remove('hidden');
            feather.replace();
        }

        function openEditEventModal(event) {
            state.selectedDate = event.date;
            state.editingEventId = event.id;
            
            elements.eventTimeSelect.innerHTML = '';
            for (let hour = CONFIG.TIME_SLOTS.start; hour <= CONFIG.TIME_SLOTS.end; hour++) {
                const time = `${String(hour).padStart(2, '0')}:00`;
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                elements.eventTimeSelect.appendChild(option);
            }
            
            elements.eventStudentSelect.innerHTML = '';
            state.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                elements.eventStudentSelect.appendChild(option);
            });
            
            elements.eventTimeSelect.value = event.time;
            elements.eventStudentSelect.value = event.studentId;
            elements.eventNotesInput.value = event.notes || '';
            elements.eventRepeatWeekly.checked = false;
            elements.eventRepeatWeekly.parentElement.style.display = 'none';
            elements.deleteEventBtn.classList.remove('hidden');
            elements.deleteEventBtn.dataset.eventId = event.id;
            
            elements.eventDateInput.value = new Date(event.date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            elements.eventModal.classList.remove('hidden');
            feather.replace();
        }

        async function saveEvent() {
            const studentId = elements.eventStudentSelect.value;
            const time = elements.eventTimeSelect.value;
            const notes = elements.eventNotesInput.value.trim();
            
            if (!studentId || !time) {
                alert('Please select a student and time');
                return;
            }
            
            elements.saveEventBtn.disabled = true;
            elements.saveEventBtn.textContent = 'Saving...';
            
            try {
                updateSyncStatus(false);
                
                if (state.editingEventId) {
                    await API.updateEvent(state.editingEventId, { time, studentId, notes });
                    const eventIndex = state.events.findIndex(e => e.id === state.editingEventId);
                    if (eventIndex !== -1) {
                        state.events[eventIndex] = {
                            ...state.events[eventIndex],
                            time, studentId, notes
                        };
                    }
                } else {
                    const existingEvent = state.events.find(e => 
                        e.date === state.selectedDate && e.time === time
                    );
                    
                    if (existingEvent) {
                        alert("An event already exists at this time. Please choose a different time.");
                        return;
                    }
                    
                    const eventData = { date: state.selectedDate, time, studentId, notes };
                    const response = await API.createEvent(eventData);
                    state.events.push(response.event);
                    
                    if (elements.eventRepeatWeekly.checked) {
                        const weeklyDates = getWeeklyDatesUntilEndOfMonth(state.selectedDate);
                        for (const weekDate of weeklyDates) {
                            const existingWeekEvent = state.events.find(e => 
                                e.date === weekDate && e.time === time
                            );
                            if (!existingWeekEvent) {
                                const weekEventData = { date: weekDate, time, studentId, notes };
                                const weekResponse = await API.createEvent(weekEventData);
                                state.events.push(weekResponse.event);
                                await new Promise(resolve => setTimeout(resolve, 10));
                            }
                        }
                    }
                }
                
                elements.eventModal.classList.add('hidden');
                renderCalendar();
                renderStudentTotals();
                renderPaymentsList();
                updateSyncStatus(true);
                showNotification('Event saved successfully!', 'success');
            } catch (error) {
                showNotification('Failed to save event', 'error');
                updateSyncStatus(true);
            } finally {
                elements.saveEventBtn.disabled = false;
                elements.saveEventBtn.textContent = 'Save';
            }
        }

        function getWeeklyDatesUntilEndOfMonth(startDateStr) {
            const startDate = new Date(startDateStr);
            const month = startDate.getMonth();
            const year = startDate.getFullYear();
            const dates = [];
            let currentDate = new Date(startDate);
            currentDate.setDate(currentDate.getDate() + 7);
            
            while (currentDate.getMonth() === month) {
                const dateStr = formatDateString(currentDate.getFullYear(), currentDate.getMonth() + 1, currentDate.getDate());
                dates.push(dateStr);
                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            return dates;
        }

        async function deleteEvent() {
            const eventId = elements.deleteEventBtn.dataset.eventId;
            
            if (!confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            elements.deleteEventBtn.disabled = true;
            elements.deleteEventBtn.textContent = 'Deleting...';
            
            try {
                updateSyncStatus(false);
                await API.deleteEvent(eventId);
                state.events = state.events.filter(e => e.id !== eventId);
                elements.eventModal.classList.add('hidden');
                renderCalendar();
                renderStudentTotals();
                renderPaymentsList();
                updateSyncStatus(true);
                showNotification('Event deleted successfully', 'success');
            } catch (error) {
                showNotification('Failed to delete event', 'error');
                updateSyncStatus(true);
            } finally {
                elements.deleteEventBtn.disabled = false;
                elements.deleteEventBtn.textContent = 'Delete';
            }
        }

        async function executeCopyEvents() {
            const copyType = elements.copyType.value;
            const fromDate = elements.copyFromDate.value;
            const toDate = elements.copyToDate.value;
            
            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }
            
            try {
                updateSyncStatus(false);
                const response = await API.copyEvents(copyType, fromDate, toDate);
                state.events.push(...response.events);
                elements.copyModal.classList.add('hidden');
                renderCalendar();
                renderStudentTotals();
                renderPaymentsList();
                updateSyncStatus(true);
                showNotification(`Successfully copied ${response.copiedCount} events!`, 'success');
            } catch (error) {
                showNotification('Failed to copy events', 'error');
                updateSyncStatus(true);
            }
        }

        function displayAnnouncementBanner() {
            if (state.announcement.active && !state.announcement.dismissed && 
                state.announcement.title && state.announcement.message) {
                elements.announcementBannerTitle.textContent = state.announcement.title;
                elements.announcementBannerMessage.textContent = state.announcement.message;
                elements.announcementBanner.classList.remove('hidden');
                feather.replace();
            } else {
                elements.announcementBanner.classList.add('hidden');
            }
        }

        function openAnnouncementModal() {
            elements.announcementTitle.value = state.announcement.title || '';
            elements.announcementMessage.value = state.announcement.message || '';
            elements.announcementActive.checked = state.announcement.active || false;
            elements.announcementModal.classList.remove('hidden');
            feather.replace();
        }

        async function saveAnnouncement() {
            const title = elements.announcementTitle.value.trim();
            const message = elements.announcementMessage.value.trim();
            const active = elements.announcementActive.checked;
            
            try {
                updateSyncStatus(false);
                await API.saveAnnouncement(title, message, active);
                state.announcement = { title, message, active, dismissed: false };
                elements.announcementModal.classList.add('hidden');
                displayAnnouncementBanner();
                updateSyncStatus(true);
                showNotification('Announcement published successfully!', 'success');
            } catch (error) {
                showNotification('Failed to save announcement', 'error');
                updateSyncStatus(true);
            }
        }

        async function deleteAnnouncement() {
            if (confirm('Are you sure you want to clear the announcement?')) {
                try {
                    updateSyncStatus(false);
                    await API.deleteAnnouncement();
                    state.announcement = { title: '', message: '', active: false, dismissed: false };
                    elements.announcementModal.classList.add('hidden');
                    displayAnnouncementBanner();
                    updateSyncStatus(true);
                    showNotification('Announcement cleared', 'success');
                } catch (error) {
                    showNotification('Failed to clear announcement', 'error');
                    updateSyncStatus(true);
                }
            }
        }

        function dismissAnnouncementBanner() {
            state.announcement.dismissed = true;
            elements.announcementBanner.classList.add('hidden');
        }

        async function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            
            if (state.isDarkMode) {
                document.documentElement.classList.add('dark');
                elements.themeToggle.innerHTML = '<i data-feather="sun" class="text-yellow-400 w-4 h-4"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                elements.themeToggle.innerHTML = '<i data-feather="moon" class="text-gray-700 w-4 h-4"></i>';
            }
            
            feather.replace();
            
            try {
                await API.updateSettings(state.isDarkMode);
            } catch (error) {
                console.error('Failed to save theme setting:', error);
            }
        }

        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        function setupEventListeners() {
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.loginCode.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            elements.logoutBtn.addEventListener('click', handleLogout);
            
            elements.prevMonthBtn.addEventListener('click', () => {
                if (state.currentMonth === 0) {
                    state.currentMonth = 11;
                    state.currentYear--;
                } else {
                    state.currentMonth--;
                }
                renderCalendar();
                renderStudentTotals();
                feather.replace();
            });
            
            elements.nextMonthBtn.addEventListener('click', () => {
                if (state.currentMonth === 11) {
                    state.currentMonth = 0;
                    state.currentYear++;
                } else {
                    state.currentMonth++;
                }
                renderCalendar();
                renderStudentTotals();
                feather.replace();
            });
            
            elements.addStudentBtn.addEventListener('click', addStudent);
            elements.newEventBtn.addEventListener('click', () => {
                const today = new Date();
                openEventModal(today.getDate(), today.getMonth() + 1, today.getFullYear());
            });
            elements.todayBtn.addEventListener('click', openTodayView);
            
            elements.closeModalBtn.addEventListener('click', () => {
                elements.eventModal.classList.add('hidden');
            });
            elements.saveEventBtn.addEventListener('click', saveEvent);
            elements.deleteEventBtn.addEventListener('click', deleteEvent);
            
            elements.closeDayViewBtn.addEventListener('click', () => {
                elements.dayViewModal.classList.add('hidden');
            });
            elements.addEventFromDayViewBtn.addEventListener('click', () => {
                elements.dayViewModal.classList.add('hidden');
                const dateParts = state.selectedDate.split('-');
                openEventModal(parseInt(dateParts[2]), parseInt(dateParts[1]), parseInt(dateParts[0]));
            });
            
            elements.closeNotesModal.addEventListener('click', () => {
                elements.notesModal.classList.add('hidden');
            });
            elements.saveStudentNotes.addEventListener('click', saveStudentNotes);
            
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            elements.studentsTab.addEventListener('click', () => {
                elements.studentsTab.classList.add('active');
                elements.paymentsTab.classList.remove('active');
                elements.studentsContent.classList.remove('hidden');
                elements.paymentsContent.classList.add('hidden');
                feather.replace();
            });
            
            elements.paymentsTab.addEventListener('click', () => {
                elements.paymentsTab.classList.add('active');
                elements.studentsTab.classList.remove('active');
                elements.paymentsContent.classList.remove('hidden');
                elements.studentsContent.classList.add('hidden');
                feather.replace();
            });
            
            elements.copyWeekBtn.addEventListener('click', () => {
                const today = new Date();
                elements.copyFromDate.value = today.toISOString().split('T')[0];
                elements.copyToDate.value = today.toISOString().split('T')[0];
                elements.copyModal.classList.remove('hidden');
            });
            
            elements.closeCopyModal.addEventListener('click', () => {
                elements.copyModal.classList.add('hidden');
            });
            elements.cancelCopy.addEventListener('click', () => {
                elements.copyModal.classList.add('hidden');
            });
            elements.executeCopy.addEventListener('click', executeCopyEvents);
            
            elements.announcementBtn.addEventListener('click', openAnnouncementModal);
            elements.closeAnnouncementModal.addEventListener('click', () => {
                elements.announcementModal.classList.add('hidden');
            });
            elements.saveAnnouncement.addEventListener('click', saveAnnouncement);
            elements.deleteAnnouncement.addEventListener('click', deleteAnnouncement);
            elements.closeAnnouncementBanner.addEventListener('click', dismissAnnouncementBanner);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            await loadAllData();
            displayAnnouncementBanner();
            renderCalendar();
            renderStudentsList();
            renderStudentTotals();
            renderPaymentsList();
            feather.replace();
        }

        // ============================================
        // APP START
        // ============================================
        (async function() {
            feather.replace();
            
            const hasAuth = checkExistingAuth();
            if (hasAuth) {
                elements.loginPage.classList.add('hidden');
                elements.appContent.classList.remove('hidden');
                updateUIForRole();
                setupEventListeners();
                await init();
            } else {
                elements.loginPage.classList.remove('hidden');
                elements.appContent.classList.add('hidden');
                setupEventListeners();
                feather.replace();
            }
        })();
    </script>
    </div>
</body>
</html>